<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ£è¯å°åº—</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            overflow: hidden;
            background: linear-gradient(180deg, #2b2b63 0%, #5a7ad1 50%, #cfe8ff 100%);
            cursor: none !important;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* éšè—æ‰€æœ‰å…ƒç´ çš„é»˜è®¤é¼ æ ‡ */
        * {
            cursor: none !important;
        }
        
        /* é¼ æ ‡è·Ÿéšå°å…”å­ */
        #bunny-cursor {
            position: fixed;
            left: 0;
            top: 0;
            pointer-events: none;
            z-index: 9999;
            width: 50px;
            height: auto;
            transform: translate(-50%, -50%);
            transition: transform 120ms ease-out;
            filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.25));
            display: block !important;
        }
        
        #main-container {
            width: 95%;
            max-width: 900px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .header-area {
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 48px;
            margin-bottom: 15px;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }
        
        .header-area > p:first-of-type {
            font-size: 18px;
            color: #fff;
            margin-bottom: 15px;
        }
        
        #countdown {
            font-size: 28px;
            margin-bottom: 15px;
            color: #ffeb3b;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        input[type="text"] {
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            margin-bottom: 15px;
            width: 220px;
            text-align: center;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 999px;
            background: linear-gradient(90deg, #ffb3d9, #ffd98a);
            color: #5a2a3a;
            font-weight: 700;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
            text-decoration: none;
            pointer-events: none;
        }
        
        .btn.active {
            pointer-events: auto;
        }
        
        .share-btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 999px;
            background: linear-gradient(90deg, #a8e6cf, #dcedc1);
            color: #2d5016;
            font-weight: 700;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        #store {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: 1fr;
            gap: 20px;
            justify-items: center;
            width: 100%;
            max-width: 700px;
        }
        
        .gift {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 1/1;
            background: #ffcccc;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            transition: transform 0.2s;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .gift:hover {
            transform: scale(1.1);
        }
        
        /* å³ä¸‹è§’å°å…”å­ */
        #bunny {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 80px;
            height: 80px;
            z-index: 998;
            transition: transform 0.3s ease;
        }
        
        #bunny:hover {
            transform: scale(1.1);
        }
        
        /* æ°”æ³¡æ ·å¼ */
        .bubble {
            position: fixed;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: 999;
            text-align: center;
        }
        
        /* å…”å­æ¶ˆæ¯å¼¹çª— */
        .bunny-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 350px;
            width: 90%;
            border: 4px solid #ffb6c1;
            animation: bounceIn 0.6s ease-out;
        }
        
        .bunny-modal::before {
            content: 'ğŸ°';
            font-size: 40px;
            display: block;
            margin-bottom: 15px;
        }
        
        .bunny-modal h3 {
            color: #e91e63;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .bunny-modal p {
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .bunny-modal input {
            padding: 10px 15px;
            border: 2px solid #ffb6c1;
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
            font-size: 16px;
            text-align: center;
        }
        
        .bunny-modal button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bunny-modal button:hover {
            transform: scale(1.05);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            70% { transform: translate(-50%, -50%) scale(0.95); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        canvas.snow {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .video-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            pointer-events: none;
            font-family: 'Great Vibes', cursive;
            text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.9);
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: move;
            user-select: none;
            padding: 10px;
            opacity: 1;
            animation: gentleGlow 4s ease-in-out infinite;
        }
        
        .video-overlay .name {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .video-overlay .merry {
            font-size: 2.8rem;
            font-weight: bold;
        }
        
        /* ç®€æ´æ¸…æ™°çš„è‰ºæœ¯å­—ä½“åŠ¨ç”» */
        @keyframes gentleGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.7));
                transform: scale(1.03);
            }
        }
        
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 22%, 24%, 55% { opacity: 0.5; }
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            h1 {
                font-size: 32px;
            }
            
            .header-area > p:first-of-type {
                font-size: 16px;
            }
            
            #countdown {
                font-size: 20px;
            }
            
            input[type="text"] {
                width: 200px;
                font-size: 14px;
            }
            
            .gift {
                max-width: 120px;
                font-size: 24px;
            }
            
            #store {
                gap: 15px;
            }
            
            .video-overlay .name {
                font-size: 2.2rem;
            }
            
            .video-overlay .merry {
                font-size: 1.8rem;
            }
            
            .bunny-modal {
                padding: 20px;
                max-width: 300px;
            }
            
            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºé»˜è®¤é¼ æ ‡ */
            #bunny-cursor {
                display: none;
            }
            
            body, * {
                cursor: auto !important;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 28px;
            }
            
            .gift {
                max-width: 100px;
                font-size: 20px;
            }
            
            #store {
                gap: 10px;
            }
            
            #bunny {
                width: 60px;
                height: 60px;
                right: 10px;
                bottom: 10px;
            }
            
            .video-overlay .name {
                font-size: 1.8rem;
            }
            
            .video-overlay .merry {
                font-size: 1.5rem;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .gift:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="snow" class="snow"></canvas>
    
    <!-- é¼ æ ‡è·Ÿéšå°å…”å­ -->
    <img id="bunny-cursor" src="assets/bunny-cursor.gif" alt="bunny cursor" />
    
    <div id="main-container">
        <div class="header-area">
            <h1>ğŸ„ æ¬¢è¿æ¥åˆ°åœ£è¯å°åº— ğŸ„</h1>
            <p>è¯·è¾“å…¥ä½ çš„åå­—å¼€å¯åœ£è¯ç¤¼ç‰©ä½“éªŒï¼š</p>
            <input type="text" id="username" placeholder="è¾“å…¥ä½ çš„åå­—" />
            <div id="countdown">å•†åº—å°†åœ¨ <span id="time">--:--:--</span> å¼€å¯</div>
            <a id="start-btn" class="btn">å¼€å¯åœ£è¯</a>
        </div>
        
        <div id="store">
            <div class="gift" data-video="1.mp4">ğŸ</div>
            <div class="gift" data-video="2.mp4">ğŸ</div>
            <div class="gift" data-video="3.mp4">ğŸ</div>
            <div class="gift" data-video="4.mp4">ğŸ</div>
            <div class="gift" data-video="5.mp4">ğŸ</div>
            <div class="gift" data-video="6.mp4">ğŸ</div>
        </div>
        
        <!-- åˆ†äº«æŒ‰é’® -->
        <button class="share-btn" id="share-btn" style="display: none;">ğŸ åˆ†äº«æˆ‘çš„åœ£è¯å°åº—</button>
    </div>
    
    <!-- å³ä¸‹è§’å°å…”å­ -->
    <img id="bunny" src="1.gif" alt="bunny" />
    
    <script>
        // =================== URLå‚æ•°å¤„ç† ===================
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                name: params.get('name') || '',
                shop: params.get('shop') || 'false'
            };
        }

        function updateUrlWithName(name) {
            const url = new URL(window.location);
            url.searchParams.set('name', name);
            url.searchParams.set('shop', 'true');
            window.history.replaceState({}, '', url);
        }

        function autoOpenShopWithName() {
            const params = getUrlParams();
            const name = params.name;
            const shouldOpenShop = params.shop === 'true';
            
            if (name && shouldOpenShop) {
                // è‡ªåŠ¨å¡«å……åå­—
                document.getElementById('username').value = name;
                
                // æ¨¡æ‹Ÿç‚¹å‡»å¼€å¯å•†åº—æŒ‰é’®
                const now = getBeijingTime();
                if (now >= targetTime) {
                    document.querySelector('#main-container h1').textContent = `ğŸ„ ${name}çš„åœ£è¯å°åº— ğŸ„`;
                    store.style.display = 'grid';
                    startBtn.style.display = 'none';
                    document.getElementById('username').style.display = 'none';
                    document.getElementById('countdown').style.display = 'none';
                    shareBtn.style.display = 'inline-block';
                    bunny.src = '3.gif';
                    
                    console.log(`ğŸ„ è‡ªåŠ¨å¼€å¯ ${name} çš„åœ£è¯å°åº—`);
                    
                    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                    setTimeout(() => {
                        showBunnyModal('æ¬¢è¿å‚è§‚ï¼', `æ¬¢è¿æ¥åˆ°${name}çš„åœ£è¯å°åº—ï¼<br>å¿«æ¥æŒ‘é€‰å–œæ¬¢çš„ç¤¼ç‰©å§ï¼ğŸ`, false);
                    }, 1000);
                } else {
                    // å¦‚æœè¿˜æ²¡åˆ°æ—¶é—´ï¼Œè‡³å°‘æ˜¾ç¤ºåå­—
                    document.getElementById('username').value = name;
                    showBunnyModal('æ¬¢è¿å›æ¥ï¼', `${name}ï¼Œå•†åº—è¿˜æ²¡å¼€é—¨å“¦ï½<br>è¯·ç­‰å¾…å€’è®¡æ—¶ç»“æŸå§ï¼ğŸ„`);
                }
            }
        }

        // =================== èƒŒæ™¯éŸ³ä¹è‡ªåŠ¨æ’­æ”¾ ===================
        const audio = new Audio();
        audio.loop = true; // å¾ªç¯æ’­æ”¾
        audio.volume = 0.5;

        // è®¾ç½®é»˜è®¤éŸ³ä¹ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„éŸ³ä¹æ–‡ä»¶ï¼‰
        audio.src = "assets/christmas-music.mp3";

        // æ£€æŸ¥æ˜¯å¦æ˜¯åœ£è¯èŠ‚å½“å¤©
        function checkIfChristmasDay() {
            const now = getBeijingTime();
            const month = now.getMonth() + 1; // æœˆä»½ä»0å¼€å§‹ï¼Œæ‰€ä»¥è¦+1
            const date = now.getDate();
            
            return month === 12 && date === 25;
        }

        // è‡ªåŠ¨æ’­æ”¾éŸ³ä¹ï¼ˆåœ£è¯èŠ‚å½“å¤©ï¼‰
        function autoPlayChristmasMusic() {
            if (checkIfChristmasDay()) {
                console.log('ğŸµ ä»Šå¤©æ˜¯åœ£è¯èŠ‚ï¼Œè‡ªåŠ¨æ’­æ”¾éŸ³ä¹');
                
                // åˆ›å»ºæ’­æ”¾æ‰¿è¯º
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('ğŸµ éŸ³ä¹è‡ªåŠ¨æ’­æ”¾æˆåŠŸ');
                    }).catch(error => {
                        console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’');
                        // åœ¨ç”¨æˆ·äº¤äº’åé‡æ–°å°è¯•æ’­æ”¾
                        document.addEventListener('click', function startAudioOnInteraction() {
                            audio.play().then(() => {
                                console.log('ğŸµ ç”¨æˆ·äº¤äº’åéŸ³ä¹æ’­æ”¾æˆåŠŸ');
                            }).catch(e => {
                                console.log('ğŸµ éŸ³ä¹æ’­æ”¾å¤±è´¥:', e);
                            });
                            document.removeEventListener('click', startAudioOnInteraction);
                        }, { once: true });
                    });
                }
            } else {
                console.log('ğŸµ ä»Šå¤©ä¸æ˜¯åœ£è¯èŠ‚ï¼Œä¸æ’­æ”¾éŸ³ä¹');
                audio.pause();
            }
        }

        // =================== ç§»åŠ¨ç«¯æ£€æµ‹ ===================
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        // =================== é¼ æ ‡è·Ÿéšå°å…”å­ ===================
        const bunnyCursor = document.getElementById('bunny-cursor');
        let isMouseMoving = false;
        
        if (!isMobileDevice()) {
            let mouseX = window.innerWidth / 2, mouseY = window.innerHeight / 2;
            let bunnyX = mouseX, bunnyY = mouseY;
            
            // ç›‘å¬æ•´ä¸ªæ–‡æ¡£çš„é¼ æ ‡ç§»åŠ¨
            document.addEventListener('mousemove', e => {
                isMouseMoving = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
                // ç¡®ä¿å°å…”å­å§‹ç»ˆåœ¨æœ€ä¸Šå±‚
                bunnyCursor.style.zIndex = '10000';
                bunnyCursor.style.display = 'block';
            });
            
            // é¼ æ ‡ç¦»å¼€çª—å£æ—¶éšè—å°å…”å­
            document.addEventListener('mouseleave', () => {
                bunnyCursor.style.display = 'none';
            });
            
            // é¼ æ ‡è¿›å…¥çª—å£æ—¶æ˜¾ç¤ºå°å…”å­
            document.addEventListener('mouseenter', () => {
                if (isMouseMoving) {
                    bunnyCursor.style.display = 'block';
                }
            });
            
            function animateBunny() {
                bunnyX += (mouseX - bunnyX) * 0.18;
                bunnyY += (mouseY - bunnyY) * 0.18;
                bunnyCursor.style.left = bunnyX + 'px';
                bunnyCursor.style.top = bunnyY + 'px';
                requestAnimationFrame(animateBunny);
            }
            animateBunny();
        } else {
            bunnyCursor.style.display = 'none';
            // ç§»åŠ¨ç«¯æ¢å¤é»˜è®¤é¼ æ ‡
            document.body.style.cursor = 'auto';
        }
        
        // =================== é›ªèŠ±ç²’å­ ===================
        const canvas = document.getElementById('snow');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        const flakes = [];
        const FLAKE_COUNT = Math.floor(Math.min(180, window.innerWidth / 6));
        
        for (let i = 0; i < FLAKE_COUNT; i++) {
            flakes.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                r: Math.random() * 3 + 1,
                d: Math.random() * FLAKE_COUNT
            });
        }
        
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.beginPath();
            for (const f of flakes) {
                ctx.moveTo(f.x, f.y);
                ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
            }
            ctx.fill();
            updateSnow();
        }
        
        let angle = 0;
        function updateSnow() {
            angle += 0.002;
            for (const f of flakes) {
                f.y += Math.cos(angle + f.d) * 0.6 + 0.5 + f.r / 2;
                f.x += Math.sin(angle) * 1.2;
                if (f.y > canvas.height + 10) {
                    f.y = -10;
                    f.x = Math.random() * canvas.width;
                }
            }
        }
        
        (function loop() {
            drawSnow();
            requestAnimationFrame(loop);
        })();
        
        // =================== åŒ—äº¬æ—¶é—´å€’è®¡æ—¶ ===================
        function getBeijingTime() {
            const now = new Date();
            const utc = now.getTime() + now.getTimezoneOffset() * 60000;
            return new Date(utc + 8 * 3600000);
        }
        
        let targetTime = (() => {
            const now = getBeijingTime();
            let year = now.getFullYear();
            let target = new Date(`${year}-12-25T00:00:00+08:00`);
            if (now >= target) {
                target = new Date(`${year + 1}-12-25T00:00:00+08:00`);
            }
            return target;
        })();
        
        const timeEl = document.getElementById('time');
        const startBtn = document.getElementById('start-btn');
        const store = document.getElementById('store');
        const shareBtn = document.getElementById('share-btn');
        
        function updateCountdown() {
            const now = getBeijingTime();
            let diff = targetTime - now;
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                timeEl.textContent = `${days}å¤© ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                startBtn.classList.remove('active');
            } else {
                timeEl.textContent = '0å¤© 00:00:00';
                startBtn.classList.add('active');
                
                // å€’è®¡æ—¶ç»“æŸåæ£€æŸ¥æ˜¯å¦æ˜¯åœ£è¯èŠ‚å¹¶è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
                autoPlayChristmasMusic();
            }
        }
        
        setInterval(updateCountdown, 1000);
        updateCountdown();
        
        // =================== ç¤¼ç›’ç‚¹å‡»æ’­æ”¾è§†é¢‘ ===================
        function setOverlayPosition(overlay, pos) {
            overlay.style.top = overlay.style.bottom = overlay.style.left = overlay.style.right = 'auto';
            overlay.style.transform = 'none';
            switch (pos) {
                case 'top-left':
                    overlay.style.top = '10px';
                    overlay.style.left = '10px';
                    break;
                case 'top-right':
                    overlay.style.top = '10px';
                    overlay.style.right = '10px';
                    break;
                case 'center':
                    overlay.style.top = '50%';
                    overlay.style.left = '50%';
                    overlay.style.transform = 'translate(-50%, -50%)';
                    break;
                case 'bottom-left':
                    overlay.style.bottom = '10px';
                    overlay.style.left = '10px';
                    break;
                case 'bottom-right':
                    overlay.style.bottom = '10px';
                    overlay.style.right = '10px';
                    break;
            }
        }
        
        // å¯æ‹–åŠ¨æ–‡å­—åŠŸèƒ½
        function makeElementDraggable(element) {
            if (isMobileDevice()) return; // ç§»åŠ¨ç«¯ä¸å¯ç”¨æ‹–åŠ¨
            
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
                element.style.transform = 'none';
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        document.querySelectorAll('.gift').forEach(gift => {
            gift.addEventListener('click', () => {
                const videoSrc = gift.dataset.video;
                const pos = gift.dataset.overlayPos || 'top-left';
                const name = document.querySelector('#main-container h1').textContent.replace('ğŸ„', '').replace('çš„åœ£è¯å°åº—', '').trim();
                
                const wrapper = document.createElement('div');
                wrapper.className = 'video-wrapper';
                
                const video = document.createElement('video');
                video.src = videoSrc;
                video.autoplay = true;
                video.controls = false;
                video.loop = true;
                
                const overlay = document.createElement('div');
                overlay.className = 'video-overlay';
                overlay.innerHTML = `<div class="name">${name}</div><div class="merry">Merry Christmas!</div>`;
                
                setOverlayPosition(overlay, pos);
                makeElementDraggable(overlay);
                
                wrapper.appendChild(video);
                wrapper.appendChild(overlay);
                document.body.appendChild(wrapper);
                
                // æ’­æ”¾èƒŒæ™¯éŸ³ä¹
                if (!isMusicPlaying && checkIfChristmasDay()) {
                    audio.play().catch(e => {
                        console.log("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾");
                    });
                    isMusicPlaying = true;
                }
                
                // åŒå‡»å…³é—­è§†é¢‘
                wrapper.addEventListener('dblclick', () => {
                    wrapper.remove();
                });
                
                // ç‚¹å‡»å…³é—­è§†é¢‘
                wrapper.addEventListener('click', (e) => {
                    if (e.target === wrapper) {
                        wrapper.remove();
                    }
                });
                
                // ç§»åŠ¨ç«¯è§¦æ‘¸å…³é—­
                wrapper.addEventListener('touchend', (e) => {
                    if (e.target === wrapper) {
                        wrapper.remove();
                    }
                });
            });
        });
        
        // =================== å…”å­æ¶ˆæ¯å¼¹çª—åŠŸèƒ½ ===================
        let currentModal = null;
        
        function showBunnyModal(title, message, showInput = false) {
            // å¦‚æœå·²ç»æœ‰å¼¹çª—ï¼Œå…ˆå…³é—­
            if (currentModal) {
                closeCurrentModal();
            }
            
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.className = 'bunny-modal';
            modal.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                ${showInput ? '<input type="text" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " maxlength="4">' : ''}
                <button id="modal-btn">${showInput ? 'ç¡®å®š' : 'å¥½çš„'}</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            currentModal = { overlay, modal };
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            const modalBtn = document.getElementById('modal-btn');
            modalBtn.addEventListener('click', handleModalButtonClick);
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            if (showInput) {
                const passwordInput = document.getElementById('password-input');
                passwordInput.focus();
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleModalButtonClick();
                    }
                });
            }
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', closeCurrentModal);
            
            function handleModalButtonClick() {
                if (showInput) {
                    const passwordInput = document.getElementById('password-input');
                    if (passwordInput.value === '0214') {
                        // å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºè°¢è°¢å‚ä¸
                        closeCurrentModal();
                        setTimeout(() => {
                            showThanksMessage();
                        }, 300);
                    } else {
                        closeCurrentModal();
                        setTimeout(() => {
                            showBunnyModal('å¯†ç é”™è¯¯', 'å°å…”å­è¯´å¯†ç ä¸å¯¹å“¦ï½å†æƒ³æƒ³å§ï¼', true);
                        }, 300);
                    }
                } else {
                    closeCurrentModal();
                }
            }
        }
        
        function closeCurrentModal() {
            if (currentModal) {
                if (document.body.contains(currentModal.overlay)) {
                    document.body.removeChild(currentModal.overlay);
                }
                if (document.body.contains(currentModal.modal)) {
                    document.body.removeChild(currentModal.modal);
                }
                currentModal = null;
            }
        }
        
        function showThanksMessage() {
            // æ˜¾ç¤ºè°¢è°¢å‚ä¸æ¶ˆæ¯
            showBunnyModal('è°¢è°¢å‚ä¸', 'æ­å–œä½ è·å¾—ï¼šè°¢è°¢å‚ä¸ï¼', false);
            
            // 2ç§’åæ˜¾ç¤ºéª—ä½ çš„æ¶ˆæ¯ï¼Œå¹¶åˆ‡æ¢ä¸º4.gif
            setTimeout(() => {
                closeCurrentModal();
                setTimeout(() => {
                    showBunnyModal('éª—ä½ çš„å•¦ï¼', 'å˜»å˜»ï½å…¶å®æ‰€æœ‰ç¤¼ç‰©éƒ½æ˜¯è°¢è°¢å‚ä¸ï¼<br>å¿«å»æ‰¾å¼€å‘è€…å…‘æ¢çœŸå®ç¤¼ç‰©å§ï¼ğŸ', false);
                    // æŠ½å¥–å®Œæˆååˆ‡æ¢ä¸º4.gif
                    bunny.src = '4.gif';
                    prizeDrawn = true;
                }, 300);
            }, 2000);
        }
        
        // =================== å³ä¸‹è§’å°å…”å­é€»è¾‘ ===================
        const bunny = document.getElementById('bunny');
        let prizeDrawn = false;
        let bunnyClickCount = 0;
        let lastBunnyClickTime = 0;
        
        bunny.addEventListener('click', () => {
            const now = getBeijingTime();
            const currentTime = Date.now();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¿«é€Ÿè¿ç»­ç‚¹å‡»ï¼ˆé˜²æ­¢è¯¯è§¦ï¼‰
            if (currentTime - lastBunnyClickTime < 500) {
                return;
            }
            lastBunnyClickTime = currentTime;
            
            if (now < targetTime) {
                // åœ£è¯æ—¶é—´æœªåˆ°ï¼Œæ¯æ¬¡ç‚¹å‡»åˆ‡æ¢gif
                bunnyClickCount++;
                
                if (bunnyClickCount === 1) {
                    // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šåˆ‡æ¢åˆ°2.gif
                    bunny.src = '2.gif';
                    showBunnyModal('è¿˜æ²¡åˆ°æ—¶é—´å“¦', 'åœ£è¯è€çˆ·çˆ·è¿˜åœ¨å‡†å¤‡ç¤¼ç‰©å‘¢ï½<br>è¯·è€å¿ƒç­‰å¾…å€’è®¡æ—¶ç»“æŸå§ï¼ğŸ„');
                } else if (bunnyClickCount === 2) {
                    // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šåˆ‡æ¢å›1.gif
                    bunny.src = '1.gif';
                    showBunnyModal('åˆ«ç€æ€¥å˜›', 'å°å…”å­è¯´ç¤¼ç‰©è¿˜åœ¨è·¯ä¸Šå‘¢ï½<br>å†ç­‰ç­‰å§ï¼ğŸ°');
                } else {
                    // ç¬¬ä¸‰æ¬¡åŠä»¥åï¼šåœ¨1.gifå’Œ2.gifä¹‹é—´åˆ‡æ¢
                    if (bunny.src.includes('1.gif')) {
                        bunny.src = '2.gif';
                        showBunnyModal('å¿«äº†å¿«äº†', 'åœ£è¯è€äººå·²ç»åœ¨è·¯ä¸Šäº†ï½<br>å†è€å¿ƒç­‰å¾…ä¸€ä¸‹ï¼ğŸ…');
                    } else {
                        bunny.src = '1.gif';
                        showBunnyModal('ç¨å®‰å‹¿èº', 'ç¾å¥½çš„äº‹ç‰©å€¼å¾—ç­‰å¾…ï½<br>å€’è®¡æ—¶ç»“æŸå°±æœ‰æƒŠå–œå“¦ï¼âœ¨');
                    }
                }
            } else {
                if (prizeDrawn) {
                    showBunnyModal('å·²ç»æŠ½è¿‡å¥–å•¦', 'æ¯ä¸ªå°å…”å­åªèƒ½æŠ½ä¸€æ¬¡å¥–å“¦ï½<br>å»æ‰¾å…¶ä»–å°å…”å­ç©å§ï¼ğŸ°');
                    return;
                }
                // æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—
                showBunnyModal('æŠ½å¥–å¯†ç ', 'å°å…”å­è¯´éœ€è¦å¯†ç æ‰èƒ½æŠ½å¥–å“¦ï½<br>è¯·è¾“å…¥4ä½æ•°å­—å¯†ç ï¼š', true);
            }
        });
        
        // =================== åˆ†äº«åŠŸèƒ½ ===================
        shareBtn.addEventListener('click', function() {
            const userName = document.getElementById('username').value.trim() || 'åœ£è¯å°ä¼™ä¼´';
            const shareText = `ğŸ„ æ¬¢è¿å‚è§‚${userName}çš„åœ£è¯å°åº—ï¼ ğŸ„\nå¿«æ¥æŒ‘é€‰ä½ çš„åœ£è¯ç¤¼ç‰©å§ï¼`;
            
            // ç”Ÿæˆå¸¦å‚æ•°çš„åˆ†äº«é“¾æ¥
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('name', userName);
            currentUrl.searchParams.set('shop', 'true');
            const shareUrl = currentUrl.toString();
            
            console.log('åˆ†äº«ä¿¡æ¯:', { userName, shareText, shareUrl });
            
            if (navigator.share) {
                // ä½¿ç”¨ Web Share API
                navigator.share({
                    title: `${userName}çš„åœ£è¯å°åº—`,
                    text: shareText,
                    url: shareUrl
                }).then(() => {
                    console.log('åˆ†äº«æˆåŠŸ');
                    showBunnyModal('åˆ†äº«æˆåŠŸ', 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼<br>è®©æ›´å¤šæœ‹å‹æ¥å‚è§‚ä½ çš„åœ£è¯å°åº—å§ï¼ğŸ…');
                }).catch((error) => {
                    console.log('åˆ†äº«å¤±è´¥:', error);
                    copyShareLink(userName, shareUrl);
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šå¤åˆ¶é“¾æ¥
                copyShareLink(userName, shareUrl);
            }
        });
        
        function copyShareLink(userName, url) {
            const shareText = `ğŸ„ æ¬¢è¿å‚è§‚${userName}çš„åœ£è¯å°åº—ï¼ ğŸ„\n${url}\nå¿«æ¥æŒ‘é€‰ä½ çš„åœ£è¯ç¤¼ç‰©å§ï¼`;
            
            // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showBunnyModal('åˆ†äº«æˆåŠŸ', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼<br>å¿«å»åˆ†äº«ç»™ä½ çš„æœ‹å‹å§ï¼ğŸ…');
                }).catch(() => {
                    fallbackCopyText(shareText);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyText(shareText);
            }
        }
        
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                if (successful) {
                    showBunnyModal('åˆ†äº«æˆåŠŸ', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼<br>å¿«å»åˆ†äº«ç»™ä½ çš„æœ‹å‹å§ï¼ğŸ…');
                } else {
                    showBunnyModal('åˆ†äº«é“¾æ¥', `è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ç»™æœ‹å‹ï¼š<br><br><span style="background: #f0f0f0; padding: 5px; border-radius: 5px; font-size: 14px;">${text}</span>`);
                }
            } catch (err) {
                document.body.removeChild(textArea);
                showBunnyModal('åˆ†äº«é“¾æ¥', `è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ç»™æœ‹å‹ï¼š<br><br><span style="background: #f0f0f0; padding: 5px; border-radius: 5px; font-size: 14px;">${text}</span>`);
            }
        }
        
        // =================== å¼€å¯å•†åº—æŒ‰é’® ===================
        startBtn.addEventListener('click', () => {
            const now = getBeijingTime();
            if (now < targetTime) {
                showBunnyModal('å•†åº—è¿˜æ²¡å¼€é—¨', 'åœ£è¯è€çˆ·çˆ·è¿˜åœ¨å‡†å¤‡ä¸­ï½<br>è¯·ç­‰å¾…å€’è®¡æ—¶ç»“æŸå“¦ï¼â°');
                return;
            }
            
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) {
                showBunnyModal('è¯·è¾“å…¥åå­—', 'å°å…”å­æƒ³çŸ¥é“ä½ çš„åå­—ï½<br>è¿™æ ·æ‰å¥½ä¸ºä½ å‡†å¤‡ç¤¼ç‰©å‘€ï¼ğŸ');
                return;
            }
            
            document.querySelector('#main-container h1').textContent = `ğŸ„ ${nameInput}çš„åœ£è¯å°åº— ğŸ„`;
            store.style.display = 'grid';
            startBtn.style.display = 'none';
            document.getElementById('username').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            shareBtn.style.display = 'inline-block';
            bunny.src = '3.gif';
            
            // æ›´æ–°URLå‚æ•°
            updateUrlWithName(nameInput);
            
            // é‡ç½®ç‚¹å‡»è®¡æ•°
            bunnyClickCount = 0;
        });

        // =================== æµ‹è¯•æ¨¡å¼ ===================
        window.enableTestMode = function() {
            // è¦†ç›– getBeijingTimeï¼Œè®©é¡µé¢è®¤ä¸ºç°åœ¨å·²ç»åˆ°åœ£è¯èŠ‚
            getBeijingTime = function() {
                return new Date('2025-12-25T00:00:00+08:00');
            };

            // ç«‹å³åˆ·æ–°å€’è®¡æ—¶æ˜¾ç¤º
            updateCountdown();

            // è‡ªåŠ¨è§£é”æŒ‰é’®
            startBtn.style.pointerEvents = 'auto';
            startBtn.classList.add('active');

            console.log('âœ… æµ‹è¯•æ¨¡å¼ï¼šå€’è®¡æ—¶ç»“æŸï¼Œå•†åº—å·²è§£é”ï¼ŒéŸ³ä¹å°†è‡ªåŠ¨æ’­æ”¾');
        };

        // åœ¨æ§åˆ¶å°è¾“å…¥ enableTestMode() å³å¯å¯ç”¨æµ‹è¯•æ¨¡å¼
        console.log('ğŸ’¡ æµ‹è¯•æç¤ºï¼šåœ¨æ§åˆ¶å°è¾“å…¥ enableTestMode() å¯ç”¨æµ‹è¯•æ¨¡å¼');
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå‚æ•°
        document.addEventListener('DOMContentLoaded', function() {
            autoPlayChristmasMusic();
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(autoOpenShopWithName, 100);
        });
        
        // éŸ³ä¹æ’­æ”¾çŠ¶æ€å˜é‡
        let isMusicPlaying = false;
    </script>
</body>
</html>