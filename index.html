<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ£è¯å°åº—</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        /* =================== æ–°å¢æ ·å¼ =================== */
        
        /* ç¤¼ç‰©äº¤æ¢ç›¸å…³æ ·å¼ */
        .exchange-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 450px;
            width: 90%;
            border: 4px solid #4CAF50;
            animation: bounceIn 0.6s ease-out;
        }
        
        .exchange-modal h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .exchange-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .exchange-item {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .exchange-item.selected {
            background: #a8e6cf;
            border-color: #4CAF50;
        }
        
        .exchange-item .item-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .exchange-item .item-name {
            font-size: 12px;
            font-weight: bold;
        }
        
        .exchange-item .item-count {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        
        .exchange-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .exchange-url {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .copy-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .copy-btn:hover {
            transform: scale(1.05);
        }
        
        .url-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .url-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .receive-btn {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
        }
        
        .exchange-btn {
            background: linear-gradient(45deg, #2196F3, #64B5F6);
            color: white;
        }
        
        .cancel-btn {
            background: linear-gradient(45deg, #f44336, #ef5350);
            color: white;
        }
        
        /* èƒŒåŒ…ç‰©å“è®¡æ•°æ ·å¼ */
        .backpack-item .item-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* åˆ†äº«é“¾æ¥æ ·å¼ */
        .share-url-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 500px;
            width: 90%;
            border: 4px solid #FF9800;
            animation: bounceIn 0.6s ease-out;
        }
        
        .share-url-modal h3 {
            color: #FF9800;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .qr-code {
            margin: 20px 0;
            padding: 10px;
            background: white;
            display: inline-block;
            border-radius: 10px;
        }
        
        /* ç”¨æˆ·IDæ˜¾ç¤ºæ ·å¼ */
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-info span {
            color: #2196F3;
        }
        
        /* åŸæ ·å¼ä¿æŒä¸å˜ï¼Œä»¥ä¸‹æ˜¯æ–°å¢å’Œä¿®æ”¹çš„éƒ¨åˆ† */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            overflow: auto;
            background: linear-gradient(180deg, #2b2b63 0%, #5a7ad1 50%, #cfe8ff 100%);
            cursor: none !important;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        /* éšè—æ»šåŠ¨æ¡ - Chrome, Safari and Opera */
        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—æ‰€æœ‰å…ƒç´ çš„é»˜è®¤é¼ æ ‡ */
        * {
            cursor: none !important;
        }
        
        /* é¼ æ ‡è·Ÿéšå°å…”å­ - ç¼©å°å°ºå¯¸ */
        #bunny-cursor {
            position: fixed;
            left: 0;
            top: 0;
            pointer-events: none;
            z-index: 9999;
            width: 30px;
            height: auto;
            transform: translate(-50%, -50%);
            transition: transform 120ms ease-out;
            filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.25));
            display: block !important;
        }
        
        #main-container {
            width: 95%;
            max-width: 900px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: auto;
        }
        
        .header-area {
            margin-bottom: 30px;
            width: 100%;
            position: relative;
        }
        
        h1 {
            font-size: 48px;
            margin-bottom: 15px;
            letter-spacing: 1px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }
        
        .header-area > p:first-of-type {
            font-size: 18px;
            color: #fff;
            margin-bottom: 15px;
        }
        
        #countdown {
            font-size: 28px;
            margin-bottom: 15px;
            color: #ffeb3b;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        input[type="text"] {
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            margin-bottom: 15px;
            width: 220px;
            text-align: center;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 999px;
            background: linear-gradient(90deg, #ffb3d9, #ffd98a);
            color: #5a2a3a;
            font-weight: 700;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
            text-decoration: none;
            pointer-events: none;
            cursor: pointer;
        }
        
        .btn.active {
            pointer-events: auto;
            cursor: pointer;
        }
        
        .share-btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 999px;
            background: linear-gradient(90deg, #a8e6cf, #dcedc1);
            color: #2d5016;
            font-weight: 700;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* VIPæŒ‰é’®æ ·å¼ */
        .vip-btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            color: #8b4513;
            font-weight: 700;
            margin-right: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            border: none;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .vip-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        
        .name-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        /* å•†åº—å¸ƒå±€æ”¹è¿› - å›ºå®š3åˆ—å¸ƒå±€ */
        #store {
            display: none;
            width: 100%;
            max-width: 700px;
            margin-bottom: 50px;
        }
        
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 100%;
            justify-items: center;
            align-items: start;
        }
        
        .gift-item {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
        }
        
        .gift-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }
        
        .gift-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .gift-image {
            width: 100%;
            aspect-ratio: 1/1;
            background: linear-gradient(135deg, #ffcccc, #ff9999);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
        }
        
        .gift-info {
            padding: 12px;
            text-align: left;
        }
        
        .gift-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .gift-price {
            font-size: 18px;
            font-weight: 700;
            color: #e74c3c;
        }
        
        .gift-original-price {
            font-size: 14px;
            color: #999;
            text-decoration: line-through;
            margin-left: 5px;
        }
        
        .gift-sales {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* å³ä¸‹è§’å°å…”å­ - ç¼©å°å°ºå¯¸ */
        #bunny {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            z-index: 998;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        #bunny:hover {
            transform: scale(1.1);
        }
        
        /* å·¦ä¸‹è§’åœ£è¯è€äºº - ç¼©å°å°ºå¯¸ */
        #santa {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 60px;
            height: 60px;
            z-index: 998;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        #santa:hover {
            transform: scale(1.1);
        }
        
        /* å·¦ä¸Šè§’åœ£è¯å…ƒç´  - æ–°å¢ */
        #top-left-gift {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 50px;
            height: 50px;
            z-index: 998;
            transition: transform 0.3s ease;
            cursor: pointer;
            display: none;
        }
        
        #top-left-gift:hover {
            transform: scale(1.1);
        }
        
        /* èƒŒåŒ…æŒ‰é’®æ ·å¼ - ä¿®æ”¹ä¸ºåœ¨å°åº—å†…æ˜¾ç¤º */
        #backpack-btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 12px;
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #fff;
            font-weight: 700;
            margin: 15px 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            border: none;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        #backpack-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
            z-index: -1;
        }
        
        #backpack-btn:hover::before {
            left: 100%;
        }
        
        #backpack-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* ç¼–è¾‘åº—é“ºåç§°æŒ‰é’® - ä¿®æ”¹ä½ç½® */
        #edit-shop-name {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            display: none;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        #edit-shop-name:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* æ°”æ³¡æ ·å¼ */
        .bubble {
            position: fixed;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: 999;
            text-align: center;
        }
        
        /* åœ£è¯è€äººé£æ ¼æ°”æ³¡ */
        .santa-bubble {
            position: fixed;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #c41e3a;
            border-radius: 16px;
            border: 3px solid #c41e3a;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
            text-align: center;
            font-weight: bold;
            max-width: 200px;
            font-size: 14px;
        }
        
        .santa-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #c41e3a transparent transparent;
        }
        
        /* å°å…”å­é£æ ¼æ°”æ³¡ */
        .bunny-bubble {
            position: fixed;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #ff6b9d;
            border-radius: 16px;
            border: 3px solid #ff6b9d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
            text-align: center;
            font-weight: bold;
            max-width: 200px;
            font-size: 14px;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        
        .bunny-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 20px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #ff6b9d transparent transparent;
        }
        
        /* å°å…”å­é£æ ¼å¼¹çª— */
        .bunny-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 350px;
            width: 90%;
            border: 4px solid #ff6b9d;
            animation: bounceIn 0.6s ease-out;
        }
        
        .bunny-modal::before {
            content: 'ğŸ°';
            font-size: 40px;
            display: block;
            margin-bottom: 15px;
        }
        
        .bunny-modal h3 {
            color: #ff6b9d;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .bunny-modal p {
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .bunny-modal input {
            padding: 10px 15px;
            border: 2px solid #ff6b9d;
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
            font-size: 16px;
            text-align: center;
        }
        
        .bunny-modal button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b9d, #ff8eb4);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bunny-modal button:hover {
            transform: scale(1.05);
        }
        
        /* å°ç‹—é£æ ¼å¼¹çª— */
        .dog-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 350px;
            width: 90%;
            border: 4px solid #ffcc99;
            animation: bounceIn 0.6s ease-out;
        }
        
        .dog-modal::before {
            content: 'ğŸ¶';
            font-size: 40px;
            display: block;
            margin-bottom: 15px;
        }
        
        .dog-modal h3 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .dog-modal p {
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dog-modal input {
            padding: 10px 15px;
            border: 2px solid #ffcc99;
            border-radius: 10px;
            margin-bottom: 15px;
            width: 100%;
            font-size: 16px;
            text-align: center;
        }
        
        .dog-modal button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #8B4513, #D2691E);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dog-modal button:hover {
            transform: scale(1.05);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            70% { transform: translate(-50%, -50%) scale(0.95); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        canvas.snow {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .video-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            pointer-events: none;
            font-family: 'Great Vibes', cursive;
            text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.9);
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcf7f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: move;
            user-select: none;
            padding: 10px;
            opacity: 1;
            animation: gentleGlow 4s ease-in-out infinite;
        }
        
        .video-overlay .name {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .video-overlay .merry {
            font-size: 2.8rem;
            font-weight: bold;
        }
        
        /* ç®€æ´æ¸…æ™°çš„è‰ºæœ¯å­—ä½“åŠ¨ç”» */
        @keyframes gentleGlow {
            0%, 100% { 
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
                transform: scale(1);
            }
            50% { 
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.7));
                transform: scale(1.03);
            }
        }
        
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 22%, 24%, 55% { opacity: 0.5; }
        }
        
        /* ç›²ç›’é¡µé¢æ ·å¼ */
        #blind-box-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-bottom: 50px;
        }
        
        #blind-boxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
            width: 100%;
            max-width: 600px;
        }
        
        .blind-box {
            width: 100%;
            max-width: 150px;
            aspect-ratio: 1/1;
            background: #ffcccc;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            transition: transform 0.2s;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        
        .blind-box:hover {
            transform: scale(1.1);
        }
        
        .blind-box.opened {
            background: #a8e6cf;
        }
        
        /* æŠ½å¥–åŠ¨ç”» */
        .lottery-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            flex-direction: column;
        }
        
        .lottery-box {
            width: 200px;
            height: 200px;
            background: #ffcccc;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            animation: pulse 1s infinite alternate;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1.1); box-shadow: 0 0 40px rgba(255, 215, 0, 0.9); }
        }
        
        .lottery-result {
            margin-top: 30px;
            font-size: 32px;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 0;
            animation: fadeIn 1s forwards 3s;
        }
        
        /* æœ€ç»ˆç¤¼ç‰©æ ·å¼ */
        #final-gift {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            z-index: 999;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        #final-gift:hover {
            transform: scale(1.1);
        }
        
        /* ç´«è‰²é£æ ¼æ°”æ³¡ */
        .purple-bubble {
            position: fixed;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #8a2be2;
            border-radius: 16px;
            border: 3px solid #8a2be2;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
            text-align: center;
            font-weight: bold;
            max-width: 200px;
            font-size: 14px;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        
        .purple-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 20px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: #8a2be2 transparent transparent;
        }
        
        /* å³ä¸Šè§’9.gifæ ·å¼ */
        #top-right-bunny {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            z-index: 999;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: none;
        }
        
        #top-right-bunny:hover {
            transform: scale(1.1);
        }
        
        /* æ¦‚ç‡è®¾ç½®å¼¹çª—æ ·å¼ - ä¿®æ”¹ä¸ºè‡ªé€‚åº” */
        .probability-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 90%;
            width: auto;
            min-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            border: 4px solid #c41e3a;
            animation: bounceIn 0.6s ease-out;
        }
        
        .probability-modal h3 {
            color: #c41e3a;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .probability-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 10px;
            flex-wrap: wrap;
        }
        
        .probability-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            min-width: 120px;
        }
        
        .probability-item .probability-slider {
            flex: 2;
            margin-right: 10px;
            min-width: 150px;
        }
        
        .probability-item .probability-value {
            width: 50px;
            text-align: center;
        }
        
        .probability-modal button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #c41e3a, #e74c3c);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .probability-modal button:hover {
            transform: scale(1.05);
        }
        
        /* è‡ªå®šä¹‰ç‰©å“è®¾ç½®æ ·å¼ - æ–°å¢ */
        .custom-items-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 90%;
            width: auto;
            min-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            border: 4px solid #4CAF50;
            animation: bounceIn 0.6s ease-out;
        }
        
        .custom-items-modal h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .custom-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 10px;
            flex-wrap: wrap;
        }
        
        .custom-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            min-width: 120px;
        }
        
        .custom-items-modal button {
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .custom-items-modal button:hover {
            transform: scale(1.05);
        }
        
        /* å°å…”å­ç›²ç›’åŠ¨ç”» */
        .bunny-blindbox-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1003;
            flex-direction: column;
        }
        
        .bunny-blindbox {
            width: 200px;
            height: 200px;
            background: #ffcccc;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
            animation: pulse 1s infinite alternate;
            cursor: pointer;
        }
        
        .bunny-blindbox-opening {
            animation: openBox 1.5s forwards;
        }
        
        @keyframes openBox {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* èƒŒåŒ…å¼¹çª—æ ·å¼ */
        .backpack-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            text-align: center;
            max-width: 90%;
            width: auto;
            min-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            border: 4px solid #4CAF50;
            animation: bounceIn 0.6s ease-out;
        }
        
        .backpack-modal h3 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .backpack-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .backpack-item {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            position: relative;
        }
        
        .backpack-item.available {
            background: #a8e6cf;
            cursor: pointer;
        }
        
        .backpack-item.unavailable {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .backpack-item .item-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .backpack-item .item-name {
            font-size: 12px;
            font-weight: bold;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            h1 {
                font-size: 32px;
            }
            
            .header-area > p:first-of-type {
                font-size: 16px;
            }
            
            #countdown {
                font-size: 20px;
            }
            
            input[type="text"] {
                width: 200px;
                font-size: 14px;
            }
            
            .gift-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .gift-item {
                max-width: 120px;
            }
            
            .gift-image {
                font-size: 28px;
            }
            
            .gift-info {
                padding: 8px;
            }
            
            .gift-title {
                font-size: 12px;
            }
            
            .gift-price {
                font-size: 14px;
            }
            
            .video-overlay .name {
                font-size: 2.2rem;
            }
            
            .video-overlay .merry {
                font-size: 1.8rem;
            }
            
            .dog-modal, .bunny-modal {
                padding: 20px;
                max-width: 300px;
            }
            
            .probability-modal, .custom-items-modal, .backpack-modal {
                padding: 15px;
                max-width: 95%;
            }
            
            .probability-item, .custom-item {
                flex-direction: column;
                align-items: stretch;
            }
            
            .probability-item input, .custom-item input {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .probability-item .probability-slider {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºé»˜è®¤é¼ æ ‡ */
            #bunny-cursor {
                display: none;
            }
            
            /* ç¡®ä¿æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´ æœ‰æ­£ç¡®å…‰æ ‡ */
            .gift-item, .blind-box, #backpack-btn, .share-btn, .vip-btn, 
            .backpack-item.available, #bunny, #santa, #top-left-gift,
            #top-right-bunny, #final-gift, button, input[type="button"],
            input[type="submit"] {
                cursor: pointer !important;
            }
            
            #bunny, #santa {
                width: 50px;
                height: 50px;
            }
            
            #bunny {
                right: 10px;
                bottom: 10px;
            }
            
            #santa {
                left: 10px;
                bottom: 10px;
            }
            
            #top-left-gift {
                width: 40px;
                height: 40px;
                left: 10px;
                top: 10px;
            }
            
            .blind-box {
                max-width: 100px;
                font-size: 24px;
            }
            
            #final-gift {
                width: 60px;
                height: 60px;
                top: 10px;
                right: 10px;
            }
            
            #top-right-bunny {
                width: 50px;
                height: 50px;
                top: 70px;
                right: 10px;
            }
            
            .name-input-container {
                flex-direction: column;
            }
            
            .vip-btn {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            /* æ–°å¢ï¼šç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
            #backpack-btn {
                padding: 15px 30px;
                font-size: 18px;
                margin: 20px auto;
                display: block;
                min-height: 50px;
                line-height: 1.5;
            }
            
            .gift-item {
                min-height: 180px;
            }
            
            .gift-info {
                padding: 10px;
            }
            
            /* ç§»åŠ¨ç«¯ç‚¹å‡»åé¦ˆ */
            .gift-item:active {
                transform: scale(0.95);
            }
            
            .blind-box:active {
                transform: scale(0.95);
            }
            
            button:active, .share-btn:active, .vip-btn:active,
            #backpack-btn:active, .backpack-item.available:active {
                opacity: 0.8;
                transform: scale(0.98);
            }
            
            /* ç”¨æˆ·ä¿¡æ¯ç§»åŠ¨ç«¯æ ·å¼ */
            .user-info {
                top: 5px;
                right: 5px;
                font-size: 10px;
                padding: 5px 8px;
            }
            
            /* äº¤æ¢å¼¹çª—ç§»åŠ¨ç«¯æ ·å¼ */
            .exchange-items {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 28px;
            }
            
            .gift-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .gift-item {
                max-width: 100px;
            }
            
            .gift-image {
                font-size: 24px;
            }
            
            .gift-info {
                padding: 6px;
            }
            
            .gift-title {
                font-size: 11px;
                line-height: 1.2;
            }
            
            .gift-price {
                font-size: 13px;
            }
            
            .gift-original-price {
                font-size: 11px;
            }
            
            .gift-sales {
                font-size: 10px;
            }
            
            .video-overlay .name {
                font-size: 1.8rem;
            }
            
            .video-overlay .merry {
                font-size: 1.5rem;
            }
            
            .blind-box {
                max-width: 80px;
                font-size: 20px;
            }
            
            #blind-boxes {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 360px) {
            .gift-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            
            .gift-item {
                max-width: 90px;
            }
            
            .gift-image {
                font-size: 20px;
            }
            
            .gift-info {
                padding: 5px;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .gift-item:hover {
                transform: none;
            }
            
            .blind-box:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
    <div class="user-info" id="user-info">
        ğŸ‘¤ ID: <span id="user-id">--</span>
    </div>
    
    <canvas id="snow" class="snow"></canvas>
    
    <!-- é¼ æ ‡è·Ÿéšå°å…”å­ -->
    <img id="bunny-cursor" src="assets/bunny-cursor.gif" alt="bunny cursor" />
    
    <!-- å·¦ä¸Šè§’åœ£è¯å…ƒç´  - æ–°å¢ -->
    <img id="top-left-gift" src="assets/10.gif" alt="Christmas Gift" />
    
    <!-- å³ä¸Šè§’å°å…”å­ - æ–°å¢ -->
    <img id="top-right-bunny" src="assets/9.gif" alt="Top Right Bunny" />
    
    <div id="main-container">
        <div class="header-area">
            <h1>ğŸ„ æ¬¢è¿æ¥åˆ°åœ£è¯å°åº— ğŸ„</h1>
            <div class="name-input-container">
                <button class="vip-btn" id="vip-btn">VIPé€šé“</button>
                <p>è¯·è¾“å…¥ä½ çš„åå­—å¼€å¯åœ£è¯ç¤¼ç‰©ä½“éªŒï¼š<button id="edit-shop-name">âœï¸</button></p>
            </div>
            <input type="text" id="username" placeholder="è¾“å…¥ä½ çš„åå­—" />
            <div id="countdown">å•†åº—å°†åœ¨ <span id="time">--:--:--</span> å¼€å¯</div>
            <a id="start-btn" class="btn">å¼€å¯åœ£è¯</a>
        </div>
        
        <div id="store">
            <div class="gift-grid">
                <!-- 15ä¸ªç¤¼ç›’ï¼Œä½¿ç”¨æ–°çš„å•†å“å¡ç‰‡å¸ƒå±€ -->
                <div class="gift-item" data-video="1.mp4" data-index="1">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’1</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®10ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="2.mp4" data-index="2">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’2</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®8ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="3.mp4" data-index="3">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’3</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®12ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="4.mp4" data-index="4">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’4</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®6ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="5.mp4" data-index="5">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’5</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®15ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="6.mp4" data-index="6">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’6</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®9ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="7.mp4" data-index="7">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’7</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®11ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="8.mp4" data-index="8">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’8</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®7ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="9.mp4" data-index="9">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’9</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®13ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="10.mp4" data-index="10">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’10</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®5ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="11.mp4" data-index="11">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’11</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®14ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="12.mp4" data-index="12">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’12</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®8ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="13.mp4" data-index="13">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’13</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®10ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="14.mp4" data-index="14">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’14</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®12ä¸‡+</div>
                    </div>
                </div>
                <div class="gift-item" data-video="15.mp4" data-index="15">
                    <div class="gift-image">ğŸ</div>
                    <div class="gift-info">
                        <div class="gift-title">åœ£è¯æƒŠå–œç¤¼ç›’15</div>
                        <div class="gift-price">åœ£è¯é™å®š<span class="gift-original-price">Â¥99</span></div>
                        <div class="gift-sales">å·²å”®16ä¸‡+</div>
                    </div>
                </div>
            </div>
            
            <!-- èƒŒåŒ…æŒ‰é’® - æ”¾åœ¨å•†åº—ç•Œé¢å†… -->
            <button id="backpack-btn">ğŸ’ æˆ‘çš„èƒŒåŒ…</button>
            
            <!-- æ–°å¢ï¼šç¤¼ç‰©äº¤æ¢æŒ‰é’® -->
            <button class="share-btn" id="exchange-btn">ğŸ”„ ç¤¼ç‰©äº¤æ¢/èµ é€</button>
            
            <!-- æ–°å¢ï¼šåˆ†äº«å°åº—é“¾æ¥æŒ‰é’® -->
            <button class="share-btn" id="share-shop-link">ğŸ”— åˆ†äº«å°åº—é“¾æ¥</button>
        </div>
        
        <!-- ç›²ç›’é¡µé¢ -->
        <div id="blind-box-container">
            <h2>ğŸ åœ£è¯ç›²ç›’æŠ½å¥– ğŸ</h2>
            <p id="blind-box-source">ä½ æœ‰3æ¬¡æœºä¼šæŠ½å–ç›²ç›’ï¼Œç‚¹å‡»ç›’å­æŸ¥çœ‹å¥–å“</p>
            <div id="blind-boxes">
                <div class="blind-box" data-index="0">?</div>
                <div class="blind-box" data-index="1">?</div>
                <div class="blind-box" data-index="2">?</div>
                <div class="blind-box" data-index="3">?</div>
                <div class="blind-box" data-index="4">?</div>
                <div class="blind-box" data-index="5">?</div>
            </div>
            <p id="blind-box-count">å‰©ä½™æŠ½å¥–æ¬¡æ•°: <span id="chances-left">3</span></p>
            <button id="back-to-store" class="share-btn">è¿”å›å°åº—</button>
        </div>
        
        <!-- ç›²ç›’æŒ‰é’® -->
        <button class="share-btn" id="share-btn" style="display: none;">ğŸ ç›²ç›’æŠ½å–</button>
    </div>
    
    <!-- å³ä¸‹è§’å°å…”å­ -->
    <img id="bunny" src="assets/1.gif" alt="bunny" />
    
    <!-- å·¦ä¸‹è§’åœ£è¯è€äºº -->
    <img id="santa" src="assets/5.gif" alt="santa" />

    <script>
        // =================== å…¨å±€å˜é‡ ===================
        let isVIP = false;
        let currentUserId = '';
        let currentUserInfo = null;
        let isVisitingOtherShop = false;
        let visitedShopOwnerId = '';
        
        // =================== ç”¨æˆ·ç³»ç»Ÿ ===================
        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            let userId = localStorage.getItem('christmas_user_id');
            if (!userId) {
                // ç”Ÿæˆæ ¼å¼: USER_éšæœº8ä½å­—ç¬¦_æ—¶é—´æˆ³
                const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
                let randomPart = '';
                for (let i = 0; i < 8; i++) {
                    randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                userId = `USER_${randomPart}_${Date.now().toString(36)}`;
                localStorage.setItem('christmas_user_id', userId);
                
                // åŒæ—¶ç”Ÿæˆç”¨æˆ·ä¿¡æ¯
                const userInfo = {
                    id: userId,
                    createdAt: Date.now(),
                    lastActive: Date.now(),
                    blindBoxDraws: {}, // è®°å½•æ¯ä¸ªåˆ†äº«è€…çš„ç›²ç›’æŠ½å–æ¬¡æ•°
                    receivedGifts: {}  // è®°å½•æ”¶åˆ°çš„ç¤¼ç‰©
                };
                localStorage.setItem('christmas_user_info', JSON.stringify(userInfo));
            }
            return userId;
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            let userInfo = localStorage.getItem('christmas_user_info');
            if (!userInfo) {
                // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ç”¨æˆ·ä¿¡æ¯
                generateUserId();
                userInfo = localStorage.getItem('christmas_user_info');
            }
            return JSON.parse(userInfo);
        }
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        function updateUserInfo(updates) {
            const userInfo = getUserInfo();
            Object.assign(userInfo, updates, { lastActive: Date.now() });
            localStorage.setItem('christmas_user_info', JSON.stringify(userInfo));
            currentUserInfo = userInfo;
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
        function initializeUserSystem() {
            currentUserId = generateUserId();
            currentUserInfo = getUserInfo();
            
            // æ˜¾ç¤ºç”¨æˆ·ID
            document.getElementById('user-id').textContent = currentUserId.substring(0, 12) + '...';
            document.getElementById('user-info').style.display = 'block';
            
            console.log('ç”¨æˆ·ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ:', { userId: currentUserId });
        }
        
        // =================== VIPçŠ¶æ€ç®¡ç† ===================
        function checkVIPStatus() {
            const vipStatus = localStorage.getItem(`vip_status_${currentUserId}`);
            return vipStatus === 'true';
        }
        
        function setVIPStatus(status) {
            localStorage.setItem(`vip_status_${currentUserId}`, status.toString());
            isVIP = status;
            console.log('è®¾ç½®VIPçŠ¶æ€:', status, 'ç”¨æˆ·ID:', currentUserId);
        }
        
        function initializeVIPStatus() {
            isVIP = checkVIPStatus();
            console.log('VIPçŠ¶æ€åˆå§‹åŒ–:', isVIP);
            if (isVIP) {
                document.getElementById('vip-btn').textContent = 'VIPå·²æ¿€æ´»';
                document.getElementById('vip-btn').style.background = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
            }
        }
        
        document.getElementById('vip-btn').addEventListener('click', function() {
            if (isVIP) {
                showBunnyModal('VIPé€šé“', 'æ‚¨å·²ç»æ˜¯VIPç”¨æˆ·ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç¤¼ç›’ï¼', false);
                return;
            }
            showBunnyModal('VIPé€šé“', 'è¯·è¾“å…¥VIPå¯†ç è§£é”æ‰€æœ‰ç¤¼ç›’ï¼š', true, 'vip');
        });
        
        // =================== èƒŒåŒ…ç³»ç»Ÿ (æ”¯æŒé‡å¤ç‰©å“) ===================
        let backpackItems = {}; // æ ¼å¼: { "åœ£è¯æƒŠå–œç¤¼ç›’1": {count: 2, data: {...}}, ... }
        
        // åˆå§‹åŒ–èƒŒåŒ…
        function initBackpack() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½èƒŒåŒ…ç‰©å“
            const savedBackpack = localStorage.getItem(`christmas_backpack_${currentUserId}`);
            if (savedBackpack) {
                backpackItems = JSON.parse(savedBackpack);
            }
            
            // åˆå§‹åŒ–èƒŒåŒ…æŒ‰é’®
            const backpackBtn = document.getElementById('backpack-btn');
            backpackBtn.style.display = 'inline-block';
            backpackBtn.addEventListener('click', showBackpack);
            
            console.log('èƒŒåŒ…åˆå§‹åŒ–å®Œæˆ:', backpackItems);
        }
        
        // æ·»åŠ ç‰©å“åˆ°èƒŒåŒ…
        function addItemToBackpack(itemName, itemData = {}) {
            if (!itemName) return;
            
            if (!backpackItems[itemName]) {
                backpackItems[itemName] = {
                    count: 1,
                    data: itemData,
                    addedAt: Date.now()
                };
            } else {
                backpackItems[itemName].count++;
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem(`christmas_backpack_${currentUserId}`, JSON.stringify(backpackItems));
            
            console.log('æ·»åŠ åˆ°èƒŒåŒ…:', itemName, 'å½“å‰æ•°é‡:', backpackItems[itemName].count);
        }
        
        // ä»èƒŒåŒ…ç§»é™¤ç‰©å“
        function removeItemFromBackpack(itemName, count = 1) {
            if (!backpackItems[itemName]) return false;
            
            if (backpackItems[itemName].count <= count) {
                delete backpackItems[itemName];
            } else {
                backpackItems[itemName].count -= count;
            }
            
            localStorage.setItem(`christmas_backpack_${currentUserId}`, JSON.stringify(backpackItems));
            return true;
        }
        
        // æ˜¾ç¤ºèƒŒåŒ…
        function showBackpack() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'backpack-modal';
            
            // åˆ›å»ºèƒŒåŒ…ç‰©å“åˆ—è¡¨
            let backpackItemsHTML = '';
            const items = Object.entries(backpackItems);
            
            if (items.length === 0) {
                backpackItemsHTML = '<p style="grid-column: 1 / -1; padding: 20px;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æŠ½å–ç¤¼ç›’å’Œç›²ç›’å§ï¼</p>';
            } else {
                items.forEach(([itemName, itemInfo]) => {
                    const icon = getItemIcon(itemName);
                    const count = itemInfo.count > 1 ? `<div class="item-count">${itemInfo.count}</div>` : '';
                    
                    backpackItemsHTML += `
                        <div class="backpack-item available" data-item-name="${itemName}">
                            <div class="item-icon">${icon}</div>
                            <div class="item-name">${itemName}</div>
                            ${count}
                        </div>
                    `;
                });
            }
            
            modal.innerHTML = `
                <h3>ğŸ’ æˆ‘çš„èƒŒåŒ… ğŸ’</h3>
                <p>è¿™é‡Œå­˜æ”¾ç€ä½ è·å¾—çš„ç¤¼ç›’å’Œç›²ç›’ç‰©å“</p>
                <div class="backpack-items">
                    ${backpackItemsHTML}
                </div>
                <div class="action-buttons">
                    <button id="backpack-close" class="cancel-btn">å…³é—­</button>
                    <button id="backpack-gift" class="exchange-btn">èµ é€/äº¤æ¢</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // èƒŒåŒ…ç‰©å“ç‚¹å‡»äº‹ä»¶
            setTimeout(() => {
                modal.querySelectorAll('.backpack-item.available').forEach(item => {
                    item.addEventListener('click', function() {
                        const itemName = this.dataset.itemName;
                        const itemInfo = backpackItems[itemName];
                        
                        if (itemName.includes('åœ£è¯æƒŠå–œç¤¼ç›’')) {
                            // æ’­æ”¾ç¤¼ç›’è§†é¢‘
                            const giftIndex = parseInt(itemName.replace('åœ£è¯æƒŠå–œç¤¼ç›’', '')) - 1;
                            playGiftVideo(giftIndex, false); // falseè¡¨ç¤ºä»èƒŒåŒ…æ’­æ”¾
                            
                            // å…³é—­èƒŒåŒ…å¼¹çª—
                            document.body.removeChild(overlay);
                            document.body.removeChild(modal);
                        }
                    });
                });
                
                // å…³é—­æŒ‰é’®
                modal.querySelector('#backpack-close').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                });
                
                // èµ é€/äº¤æ¢æŒ‰é’®
                modal.querySelector('#backpack-gift').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    showGiftExchangeModal();
                });
            }, 100);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        // =================== ç¤¼ç‰©äº¤æ¢/èµ é€ç³»ç»Ÿ ===================
        function showGiftExchangeModal() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'exchange-modal';
            
            // è·å–å¯äº¤æ¢çš„ç‰©å“
            let exchangeItemsHTML = '';
            const items = Object.entries(backpackItems);
            
            if (items.length === 0) {
                exchangeItemsHTML = '<p style="grid-column: 1 / -1; padding: 20px;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œæ²¡æœ‰å¯äº¤æ¢çš„ç‰©å“</p>';
            } else {
                let selectedItem = null;
                items.forEach(([itemName, itemInfo]) => {
                    const icon = getItemIcon(itemName);
                    const count = itemInfo.count > 1 ? `<div class="item-count">x${itemInfo.count}</div>` : '';
                    
                    exchangeItemsHTML += `
                        <div class="exchange-item" data-item-name="${itemName}" data-count="${itemInfo.count}">
                            <div class="item-icon">${icon}</div>
                            <div class="item-name">${itemName}</div>
                            ${count}
                        </div>
                    `;
                });
            }
            
            modal.innerHTML = `
                <h3>ğŸ”„ ç¤¼ç‰©äº¤æ¢/èµ é€</h3>
                <p>é€‰æ‹©ä¸€ä¸ªç‰©å“è¿›è¡Œäº¤æ¢æˆ–èµ é€</p>
                <div class="exchange-items" id="exchange-items">
                    ${exchangeItemsHTML}
                </div>
                <div id="exchange-actions" style="display: none;">
                    <div class="exchange-info">
                        <p>å·²é€‰æ‹©: <strong id="selected-item-name">--</strong></p>
                        <p>æ•°é‡: <span id="selected-item-count">--</span></p>
                    </div>
                    <div class="action-buttons">
                        <button id="gift-action" class="receive-btn">èµ é€</button>
                        <button id="exchange-action" class="exchange-btn">äº¤æ¢</button>
                        <button id="cancel-selection" class="cancel-btn">å–æ¶ˆé€‰æ‹©</button>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="close-exchange" class="cancel-btn">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // ç‰©å“é€‰æ‹©äº‹ä»¶
            setTimeout(() => {
                const exchangeItems = modal.querySelectorAll('.exchange-item');
                let selectedItem = null;
                
                exchangeItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–ç‰©å“çš„é€‰æ‹©çŠ¶æ€
                        exchangeItems.forEach(i => i.classList.remove('selected'));
                        
                        // è®¾ç½®å½“å‰ç‰©å“ä¸ºé€‰æ‹©çŠ¶æ€
                        this.classList.add('selected');
                        selectedItem = this;
                        
                        // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                        const actionsDiv = modal.querySelector('#exchange-actions');
                        actionsDiv.style.display = 'block';
                        
                        // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
                        modal.querySelector('#selected-item-name').textContent = this.dataset.itemName;
                        modal.querySelector('#selected-item-count').textContent = this.dataset.count;
                    });
                });
                
                // èµ é€æŒ‰é’®
                modal.querySelector('#gift-action').addEventListener('click', () => {
                    if (selectedItem) {
                        document.body.removeChild(overlay);
                        document.body.removeChild(modal);
                        showGiftUrlModal(selectedItem.dataset.itemName, 'gift');
                    }
                });
                
                // äº¤æ¢æŒ‰é’®
                modal.querySelector('#exchange-action').addEventListener('click', () => {
                    if (selectedItem) {
                        document.body.removeChild(overlay);
                        document.body.removeChild(modal);
                        showGiftUrlModal(selectedItem.dataset.itemName, 'exchange');
                    }
                });
                
                // å–æ¶ˆé€‰æ‹©
                modal.querySelector('#cancel-selection').addEventListener('click', () => {
                    if (selectedItem) {
                        selectedItem.classList.remove('selected');
                        selectedItem = null;
                        modal.querySelector('#exchange-actions').style.display = 'none';
                    }
                });
                
                // å…³é—­æŒ‰é’®
                modal.querySelector('#close-exchange').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                });
            }, 100);
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        // æ˜¾ç¤ºèµ é€/äº¤æ¢URLç”Ÿæˆæ¨¡æ€æ¡†
        function showGiftUrlModal(itemName, actionType) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            // ç”Ÿæˆå”¯ä¸€çš„ç¤¼ç‰©ID
            const giftId = `GIFT_${Math.random().toString(36).substr(2, 9)}_${Date.now().toString(36)}`;
            const actionText = actionType === 'gift' ? 'èµ é€' : 'äº¤æ¢';
            
            // åˆ›å»ºç¤¼ç‰©æ•°æ®
            const giftData = {
                id: giftId,
                itemName: itemName,
                actionType: actionType,
                fromUserId: currentUserId,
                fromUserName: document.querySelector('#main-container h1').textContent.replace('ğŸ„', '').replace('çš„åœ£è¯å°åº—', '').replace('ğŸ„', '').trim(),
                createdAt: Date.now(),
                expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7å¤©åè¿‡æœŸ
            };
            
            // ä¿å­˜ç¤¼ç‰©æ•°æ®
            localStorage.setItem(`gift_${giftId}`, JSON.stringify(giftData));
            
            // ç”Ÿæˆåˆ†äº«URL
            const baseUrl = window.location.origin + window.location.pathname;
            const giftUrl = `${baseUrl}?gift=${giftId}`;
            
            const modal = document.createElement('div');
            modal.className = 'exchange-modal';
            modal.innerHTML = `
                <h3>ğŸ ${actionText}é“¾æ¥ç”Ÿæˆ</h3>
                <p>å·²é€‰æ‹© <strong>${itemName}</strong> è¿›è¡Œ${actionText}</p>
                <p>å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å¥½å‹ï¼š</p>
                <div class="url-container">
                    <input type="text" class="url-input" value="${giftUrl}" readonly id="gift-url-input">
                    <button class="copy-btn" id="copy-gift-url">å¤åˆ¶</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    âš ï¸ æ³¨æ„ï¼šæ­¤é“¾æ¥7å¤©å†…æœ‰æ•ˆï¼Œä½¿ç”¨åä¼šè‡ªåŠ¨å¤±æ•ˆ
                </p>
                <div class="action-buttons">
                    <button id="close-gift-url" class="cancel-btn">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            modal.querySelector('#copy-gift-url').addEventListener('click', () => {
                const urlInput = modal.querySelector('#gift-url-input');
                urlInput.select();
                document.execCommand('copy');
                showBunnyModal('å¤åˆ¶æˆåŠŸ', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', false);
            });
            
            // å…³é—­æŒ‰é’®
            modal.querySelector('#close-gift-url').addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        // å¤„ç†ç¤¼ç‰©URL
        function processGiftUrl(giftId) {
            const giftDataStr = localStorage.getItem(`gift_${giftId}`);
            if (!giftDataStr) {
                showBunnyModal('ç¤¼ç‰©æ— æ•ˆ', 'ç¤¼ç‰©é“¾æ¥å·²å¤±æ•ˆæˆ–ä¸å­˜åœ¨ï¼', false);
                return;
            }
            
            const giftData = JSON.parse(giftDataStr);
            
            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (giftData.expiresAt < Date.now()) {
                showBunnyModal('ç¤¼ç‰©è¿‡æœŸ', 'ç¤¼ç‰©é“¾æ¥å·²è¿‡æœŸï¼', false);
                localStorage.removeItem(`gift_${giftId}`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„ç¤¼ç‰©
            if (giftData.fromUserId === currentUserId) {
                showBunnyModal('æ— æ³•é¢†å–', 'è¿™æ˜¯æ‚¨è‡ªå·±å‘é€çš„ç¤¼ç‰©é“¾æ¥ï¼', false);
                return;
            }
            
            const actionText = giftData.actionType === 'gift' ? 'èµ é€' : 'äº¤æ¢';
            const modalTitle = giftData.actionType === 'gift' ? 'ğŸ æ”¶åˆ°ç¤¼ç‰©' : 'ğŸ”„ äº¤æ¢è¯·æ±‚';
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'exchange-modal';
            
            if (giftData.actionType === 'gift') {
                // èµ é€æ¨¡å¼
                modal.innerHTML = `
                    <h3>${modalTitle}</h3>
                    <p><strong>${giftData.fromUserName}</strong> å‘ä½ ${actionText}äº†ä¸€ä¸ªç¤¼ç‰©ï¼š</p>
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div style="font-size: 24px;">${getItemIcon(giftData.itemName)}</div>
                        <div style="font-weight: bold; font-size: 16px;">${giftData.itemName}</div>
                    </div>
                    <p>æ˜¯å¦æ¥å—è¿™ä¸ªç¤¼ç‰©ï¼Ÿ</p>
                    <div class="action-buttons">
                        <button id="accept-gift" class="receive-btn">æ¥å—</button>
                        <button id="decline-gift" class="cancel-btn">æ‹’ç»</button>
                    </div>
                `;
            } else {
                // äº¤æ¢æ¨¡å¼
                modal.innerHTML = `
                    <h3>${modalTitle}</h3>
                    <p><strong>${giftData.fromUserName}</strong> æƒ³ç”¨ä»¥ä¸‹ç‰©å“ä¸ä½ äº¤æ¢ï¼š</p>
                    <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div style="font-size: 24px;">${getItemIcon(giftData.itemName)}</div>
                        <div style="font-weight: bold; font-size: 16px;">${giftData.itemName}</div>
                    </div>
                    <p>è¯·é€‰æ‹©ä½ è¦äº¤æ¢çš„ç‰©å“ï¼š</p>
                    <div class="exchange-items" id="exchange-response-items"></div>
                    <div class="action-buttons">
                        <button id="accept-exchange" class="exchange-btn" disabled>ç¡®è®¤äº¤æ¢</button>
                        <button id="decline-exchange" class="cancel-btn">æ‹’ç»</button>
                    </div>
                `;
            }
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            if (giftData.actionType === 'gift') {
                // èµ é€æ¨¡å¼äº‹ä»¶å¤„ç†
                modal.querySelector('#accept-gift').addEventListener('click', () => {
                    // æ·»åŠ åˆ°èƒŒåŒ…
                    addItemToBackpack(giftData.itemName, { from: giftData.fromUserId, giftId: giftId });
                    
                    // åˆ é™¤ç¤¼ç‰©æ•°æ®
                    localStorage.removeItem(`gift_${giftId}`);
                    
                    // æ›´æ–°ç”¨æˆ·æ”¶åˆ°çš„ç¤¼ç‰©è®°å½•
                    updateUserInfo({
                        receivedGifts: {
                            ...currentUserInfo.receivedGifts,
                            [giftId]: { ...giftData, receivedAt: Date.now() }
                        }
                    });
                    
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    
                    showBunnyModal('æ¥å—æˆåŠŸ', `ä½ å·²æˆåŠŸæ”¶åˆ° <strong>${giftData.itemName}</strong>ï¼`, false);
                });
                
                modal.querySelector('#decline-gift').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    showBunnyModal('å·²æ‹’ç»', 'ä½ æ‹’ç»äº†è¿™ä»½ç¤¼ç‰©ã€‚', false);
                });
            } else {
                // äº¤æ¢æ¨¡å¼äº‹ä»¶å¤„ç†
                // åŠ è½½ç”¨æˆ·çš„å¯äº¤æ¢ç‰©å“
                let exchangeResponseHTML = '';
                const items = Object.entries(backpackItems);
                
                items.forEach(([itemName, itemInfo]) => {
                    // ä¸èƒ½äº¤æ¢è‡ªå·±æ”¶åˆ°çš„ç¤¼ç‰©
                    if (itemInfo.data && itemInfo.data.giftId === giftId) return;
                    
                    const icon = getItemIcon(itemName);
                    const count = itemInfo.count > 1 ? `<div class="item-count">x${itemInfo.count}</div>` : '';
                    
                    exchangeResponseHTML += `
                        <div class="exchange-item" data-item-name="${itemName}" data-count="${itemInfo.count}">
                            <div class="item-icon">${icon}</div>
                            <div class="item-name">${itemName}</div>
                            ${count}
                        </div>
                    `;
                });
                
                modal.querySelector('#exchange-response-items').innerHTML = exchangeResponseHTML;
                
                let selectedExchangeItem = null;
                
                // ç‰©å“é€‰æ‹©äº‹ä»¶
                setTimeout(() => {
                    const exchangeItems = modal.querySelectorAll('.exchange-item');
                    
                    exchangeItems.forEach(item => {
                        item.addEventListener('click', function() {
                            exchangeItems.forEach(i => i.classList.remove('selected'));
                            this.classList.add('selected');
                            selectedExchangeItem = this;
                            modal.querySelector('#accept-exchange').disabled = false;
                        });
                    });
                }, 100);
                
                modal.querySelector('#accept-exchange').addEventListener('click', () => {
                    if (!selectedExchangeItem) return;
                    
                    const userItemName = selectedExchangeItem.dataset.itemName;
                    
                    // ä»å½“å‰ç”¨æˆ·èƒŒåŒ…ä¸­ç§»é™¤ç‰©å“
                    if (!removeItemFromBackpack(userItemName, 1)) {
                        showBunnyModal('äº¤æ¢å¤±è´¥', 'ç‰©å“æ•°é‡ä¸è¶³ï¼', false);
                        return;
                    }
                    
                    // å°†å¯¹æ–¹ç‰©å“æ·»åŠ åˆ°å½“å‰ç”¨æˆ·èƒŒåŒ…
                    addItemToBackpack(giftData.itemName, { 
                        from: giftData.fromUserId, 
                        giftId: giftId,
                        exchangedItem: userItemName 
                    });
                    
                    // åˆ é™¤ç¤¼ç‰©æ•°æ®
                    localStorage.removeItem(`gift_${giftId}`);
                    
                    // åˆ›å»ºäº¤æ¢è®°å½•
                    const exchangeRecord = {
                        id: giftId,
                        fromUserId: giftData.fromUserId,
                        toUserId: currentUserId,
                        fromItem: giftData.itemName,
                        toItem: userItemName,
                        exchangedAt: Date.now()
                    };
                    
                    localStorage.setItem(`exchange_${giftId}`, JSON.stringify(exchangeRecord));
                    
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    
                    showBunnyModal('äº¤æ¢æˆåŠŸ', 
                        `äº¤æ¢å®Œæˆï¼<br>ä½ è·å¾—äº†: <strong>${giftData.itemName}</strong><br>å¯¹æ–¹è·å¾—äº†: <strong>${userItemName}</strong>`, 
                        false);
                });
                
                modal.querySelector('#decline-exchange').addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                    showBunnyModal('å·²æ‹’ç»', 'ä½ æ‹’ç»äº†äº¤æ¢è¯·æ±‚ã€‚', false);
                });
            }
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        // =================== ç›²ç›’ç³»ç»Ÿ (é‡æ–°è®¾è®¡) ===================
        let blindBoxItems = []; // æ ¼å¼: { name: 'åœ£è¯æƒŠå–œç¤¼ç›’1', probability: 20 }
        let blindBoxChances = 3;
        let blindBoxPrizes = [];
        let blindBoxOpened = [];
        let currentBlindBoxSource = 'own'; // 'own' æˆ– 'shared_{userId}'
        
        // åˆå§‹åŒ–ç›²ç›’è®¾ç½® - é»˜è®¤åŒ…å«5ä¸ªéšæœºç¤¼ç›’å’Œ1ä¸ªè°¢è°¢æƒ é¡¾
        function initializeDefaultBlindBoxItems() {
            // éšæœºé€‰æ‹©5ä¸ªä¸åŒçš„ç¤¼ç›’
            const allGifts = Array.from({length: 15}, (_, i) => `åœ£è¯æƒŠå–œç¤¼ç›’${i + 1}`);
            const selectedGifts = [];
            const usedIndexes = new Set();
            
            while (selectedGifts.length < 5) {
                const randomIndex = Math.floor(Math.random() * allGifts.length);
                if (!usedIndexes.has(randomIndex)) {
                    selectedGifts.push(allGifts[randomIndex]);
                    usedIndexes.add(randomIndex);
                }
            }
            
            // è®¾ç½®æ¦‚ç‡ï¼šæ¯ä¸ªç¤¼ç›’15%ï¼Œè°¢è°¢æƒ é¡¾25%
            blindBoxItems = selectedGifts.map(gift => ({
                name: gift,
                probability: 15
            }));
            
            // æ·»åŠ è°¢è°¢æƒ é¡¾
            blindBoxItems.push({
                name: 'è°¢è°¢æƒ é¡¾',
                probability: 25
            });
            
            console.log('é»˜è®¤ç›²ç›’è®¾ç½®:', blindBoxItems);
        }
        
        // ç”Ÿæˆç›²ç›’å¥–å“
        function generateBlindBoxPrizes() {
            // æ¸…ç©ºä¹‹å‰çš„å¥–å“
            blindBoxPrizes = [];
            blindBoxOpened = [];
            
            // åˆ›å»ºæ¦‚ç‡æ± 
            let probabilityPool = [];
            blindBoxItems.forEach(item => {
                for (let i = 0; i < item.probability; i++) {
                    probabilityPool.push(item.name);
                }
            });
            
            // æ‰“ä¹±æ¦‚ç‡æ± 
            for (let i = probabilityPool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [probabilityPool[i], probabilityPool[j]] = [probabilityPool[j], probabilityPool[i]];
            }
            
            // ç”Ÿæˆ6ä¸ªå¥–å“
            for (let i = 0; i < 6; i++) {
                const randomIndex = Math.floor(Math.random() * probabilityPool.length);
                blindBoxPrizes.push(probabilityPool[randomIndex]);
                probabilityPool.splice(randomIndex, 1); // ç§»é™¤å·²é€‰å¥–å“
                
                // å¦‚æœæ¦‚ç‡æ± ç©ºäº†ï¼Œé‡æ–°å¡«å……
                if (probabilityPool.length === 0) {
                    blindBoxItems.forEach(item => {
                        for (let j = 0; j < item.probability; j++) {
                            probabilityPool.push(item.name);
                        }
                    });
                }
            }
            
            console.log('ç”Ÿæˆçš„ç›²ç›’å¥–å“:', blindBoxPrizes);
        }
        
        // åˆå§‹åŒ–ç›²ç›’é¡µé¢
        function initBlindBoxPage() {
            // é‡ç½®çŠ¶æ€
            blindBoxOpened = new Array(6).fill(false);
            
            // ç”Ÿæˆå¥–å“
            generateBlindBoxPrizes();
            
            // æ›´æ–°æ˜¾ç¤º
            updateBlindBoxDisplay();
            
            console.log('ç›²ç›’é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ›´æ–°ç›²ç›’æ˜¾ç¤º
        function updateBlindBoxDisplay() {
            const boxes = document.querySelectorAll('.blind-box');
            boxes.forEach((box, index) => {
                if (blindBoxOpened[index]) {
                    box.classList.add('opened');
                    const prize = blindBoxPrizes[index];
                    box.textContent = prize === 'è°¢è°¢æƒ é¡¾' ? 'è°¢è°¢æƒ é¡¾' : 'ğŸ';
                    box.style.background = prize === 'è°¢è°¢æƒ é¡¾' ? '#cccccc' : '#a8e6cf';
                } else {
                    box.classList.remove('opened');
                    box.textContent = '?';
                    box.style.background = '#ffcccc';
                }
            });
            
            document.getElementById('chances-left').textContent = blindBoxChances;
        }
        
        // æ‰“å¼€ç›²ç›’
        function openBlindBox(index) {
            if (blindBoxChances <= 0) {
                showBunnyModal('æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œ', 'ä½ çš„ç›²ç›’æŠ½å¥–æ¬¡æ•°å·²ç»ç”¨å®Œå•¦ï¼', false);
                return;
            }
            
            if (blindBoxOpened[index]) {
                showBunnyModal('æç¤º', 'è¿™ä¸ªç›²ç›’å·²ç»å¼€å¯è¿‡äº†ï¼', false);
                return;
            }
            
            blindBoxChances--;
            blindBoxOpened[index] = true;
            
            const prize = blindBoxPrizes[index];
            
            // æ›´æ–°æ˜¾ç¤º
            updateBlindBoxDisplay();
            
            // å¤„ç†å¥–å“
            if (prize !== 'è°¢è°¢æƒ é¡¾') {
                // æ·»åŠ åˆ°èƒŒåŒ…
                addItemToBackpack(prize);
                
                showBunnyModal('æ­å–œï¼', `ä½ æŠ½ä¸­äº† <strong>${prize}</strong>ï¼<br>ç‰©å“å·²æ”¾å…¥ä½ çš„èƒŒåŒ…ã€‚`, false);
            } else {
                showBunnyModal('è°¢è°¢æƒ é¡¾', 'å¾ˆé—æ†¾ï¼Œè¿™ä¸ªç›²ç›’æ˜¯è°¢è°¢æƒ é¡¾ï¼<br>è¿˜æœ‰æœºä¼šï¼Œå†è¯•è¯•å§ï¼', false);
            }
            
            // ä¿å­˜æŠ½å–è®°å½•ï¼ˆå¦‚æœæ˜¯è®¿é—®åˆ«äººçš„å°åº—ï¼‰
            if (currentBlindBoxSource.startsWith('shared_')) {
                const sourceUserId = currentBlindBoxSource.replace('shared_', '');
                updateUserBlindBoxDraws(sourceUserId, 1);
            }
            
            // æ£€æŸ¥æ˜¯å¦ç”¨å®Œæ¬¡æ•°
            if (blindBoxChances === 0) {
                const santa = document.getElementById('santa');
                if (santa) santa.src = 'assets/8.gif';
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ç›²ç›’æŠ½å–è®°å½•
        function updateUserBlindBoxDraws(sourceUserId, draws = 1) {
            const userInfo = getUserInfo();
            
            if (!userInfo.blindBoxDraws) {
                userInfo.blindBoxDraws = {};
            }
            
            if (!userInfo.blindBoxDraws[sourceUserId]) {
                userInfo.blindBoxDraws[sourceUserId] = 0;
            }
            
            userInfo.blindBoxDraws[sourceUserId] += draws;
            updateUserInfo({ blindBoxDraws: userInfo.blindBoxDraws });
            
            console.log(`ç”¨æˆ· ${currentUserId} åœ¨ ${sourceUserId} çš„å°åº—æŠ½å–äº† ${draws} æ¬¡`);
        }
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ½å–æŸäººçš„ç›²ç›’
        function canDrawBlindBox(sourceUserId) {
            const userInfo = getUserInfo();
            
            // å¦‚æœæ˜¯è‡ªå·±çš„å°åº—ï¼Œæ£€æŸ¥è‡ªå·±çš„æ¬¡æ•°
            if (sourceUserId === currentUserId) {
                return blindBoxChances > 0;
            }
            
            // å¦‚æœæ˜¯åˆ«äººçš„å°åº—ï¼Œæ£€æŸ¥æŠ½å–è®°å½•
            if (userInfo.blindBoxDraws && userInfo.blindBoxDraws[sourceUserId]) {
                return userInfo.blindBoxDraws[sourceUserId] < 3;
            }
            
            return true; // ä»æœªæŠ½å–è¿‡ï¼Œå¯ä»¥æŠ½å–
        }
        
        // è·å–å‰©ä½™æŠ½å–æ¬¡æ•°
        function getRemainingDraws(sourceUserId) {
            if (sourceUserId === currentUserId) {
                return blindBoxChances;
            }
            
            const userInfo = getUserInfo();
            if (userInfo.blindBoxDraws && userInfo.blindBoxDraws[sourceUserId]) {
                return 3 - userInfo.blindBoxDraws[sourceUserId];
            }
            
            return 3;
        }
        
        // æ˜¾ç¤ºç›²ç›’é¡µé¢
        function showBlindBoxPage(sourceUserId = 'own') {
            document.getElementById('store').style.display = 'none';
            document.getElementById('blind-box-container').style.display = 'flex';
            document.getElementById('share-btn').style.display = 'none';
            
            // è®¾ç½®ç›²ç›’æ¥æº
            currentBlindBoxSource = sourceUserId === currentUserId ? 'own' : `shared_${sourceUserId}`;
            
            // è®¾ç½®æ ‡é¢˜å’Œæç¤º
            if (sourceUserId === currentUserId) {
                document.getElementById('blind-box-source').textContent = 'ä½ æœ‰3æ¬¡æœºä¼šæŠ½å–ç›²ç›’ï¼Œç‚¹å‡»ç›’å­æŸ¥çœ‹å¥–å“';
                blindBoxChances = getRemainingDraws(sourceUserId);
            } else {
                document.getElementById('blind-box-source').textContent = `åœ¨ ${visitedShopOwnerId ? 'å¥½å‹' : 'è¿™ä¸ª'}å°åº—æŠ½å–ç›²ç›’`;
                blindBoxChances = getRemainingDraws(sourceUserId);
            }
            
            // åˆå§‹åŒ–ç›²ç›’
            initBlindBoxPage();
            
            // åˆå§‹åŒ–ç›²ç›’ç‚¹å‡»äº‹ä»¶
            initBlindBoxEvents();
        }
        
        // åˆå§‹åŒ–ç›²ç›’ç‚¹å‡»äº‹ä»¶
        function initBlindBoxEvents() {
            const boxes = document.querySelectorAll('.blind-box');
            boxes.forEach((box, index) => {
                box.removeEventListener('click', handleBoxClick);
                box.addEventListener('click', handleBoxClick);
                
                function handleBoxClick() {
                    openBlindBox(index);
                }
            });
        }
        
        // =================== åˆ†äº«ç³»ç»Ÿ ===================
        // åˆ†äº«å°åº—é“¾æ¥
        document.getElementById('share-shop-link').addEventListener('click', function() {
            const shopName = document.querySelector('#main-container h1').textContent.replace('ğŸ„', '').replace('çš„åœ£è¯å°åº—', '').replace('ğŸ„', '').trim();
            
            // åˆ›å»ºåˆ†äº«æ•°æ®
            const shareData = {
                shopName: shopName,
                blindBoxItems: blindBoxItems,
                ownerUserId: currentUserId,
                timestamp: Date.now()
            };
            
            // ç¼–ç åˆ†äº«æ•°æ®
            const encodedData = encodeURIComponent(JSON.stringify(shareData));
            
            // ç”Ÿæˆåˆ†äº«é“¾æ¥
            const currentUrl = new URL(window.location.href);
            const baseUrl = currentUrl.origin + currentUrl.pathname;
            const shareUrl = `${baseUrl}?share=${encodedData}`;
            
            // æ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
            showShareUrlModal(shareUrl, shopName);
        });
        
        // æ˜¾ç¤ºåˆ†äº«é“¾æ¥æ¨¡æ€æ¡†
        function showShareUrlModal(shareUrl, shopName) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'share-url-modal';
            modal.innerHTML = `
                <h3>ğŸ”— åˆ†äº«å°åº—é“¾æ¥</h3>
                <p>åˆ†äº« <strong>${shopName}</strong> çš„åœ£è¯å°åº—ç»™å¥½å‹ï¼</p>
                <p>å¥½å‹å¯ä»¥é€šè¿‡æ­¤é“¾æ¥è®¿é—®ä½ çš„å°åº—å¹¶æŠ½å–ç›²ç›’</p>
                <div class="url-container">
                    <input type="text" class="url-input" value="${shareUrl}" readonly id="share-url-input">
                    <button class="copy-btn" id="copy-share-url">å¤åˆ¶</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    âš ï¸ æ³¨æ„ï¼šæ¯ä¸ªå¥½å‹åªèƒ½æŠ½å–3æ¬¡ç›²ç›’ï¼Œé‡å¤è®¿é—®æ— æ³•é‡å¤æŠ½å–
                </p>
                <div class="action-buttons">
                    <button id="close-share-url" class="cancel-btn">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // å¤åˆ¶é“¾æ¥æŒ‰é’®
            modal.querySelector('#copy-share-url').addEventListener('click', () => {
                const urlInput = modal.querySelector('#share-url-input');
                urlInput.select();
                document.execCommand('copy');
                showBunnyModal('å¤åˆ¶æˆåŠŸ', 'é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', false);
            });
            
            // å…³é—­æŒ‰é’®
            modal.querySelector('#close-share-url').addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
            });
            
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        // å¤„ç†åˆ†äº«é“¾æ¥
        function processShareUrl(shareData) {
            isVisitingOtherShop = true;
            visitedShopOwnerId = shareData.ownerUserId;
            
            // è®¾ç½®å°åº—åç§°
            document.querySelector('#main-container h1').textContent = `ğŸ„ ${shareData.shopName}çš„åœ£è¯å°åº— ğŸ„`;
            
            // è®¾ç½®ç›²ç›’è®¾ç½®
            if (shareData.blindBoxItems && shareData.blindBoxItems.length > 0) {
                blindBoxItems = shareData.blindBoxItems;
            } else {
                initializeDefaultBlindBoxItems();
            }
            
            // éšè—ä¸éœ€è¦çš„æŒ‰é’®
            document.getElementById('edit-shop-name').style.display = 'none';
            document.getElementById('backpack-btn').style.display = 'none';
            document.getElementById('exchange-btn').style.display = 'none';
            
            // æ˜¾ç¤ºç›²ç›’æŒ‰é’®
            document.getElementById('share-btn').style.display = 'inline-block';
            document.getElementById('share-btn').textContent = 'ğŸ æŠ½å–ç›²ç›’';
            
            // æ›´æ–°å•†åº—çŠ¶æ€
            const store = document.getElementById('store');
            store.style.display = 'block';
            
            // åˆå§‹åŒ–ç¤¼ç›’äº‹ä»¶ï¼ˆåªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½å¼€å¯ï¼‰
            initGiftEventsForVisitor();
            
            showBunnyModal('æ¬¢è¿è®¿é—®', `æ¬¢è¿æ¥åˆ° <strong>${shareData.shopName}</strong> çš„åœ£è¯å°åº—ï¼<br>ä½ å¯ä»¥åœ¨è¿™é‡ŒæŠ½å–ç›²ç›’ï¼Œå¥–å“ä¼šæ”¾å…¥ä½ çš„èƒŒåŒ…ã€‚`, false);
        }
        
        // =================== URLå‚æ•°å¤„ç† ===================
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const shareParam = params.get('share');
            const giftParam = params.get('gift');
            const nameParam = params.get('name');
            const shopParam = params.get('shop');
            
            return {
                name: nameParam || '',
                shop: shopParam || 'false',
                share: shareParam || '',
                gift: giftParam || ''
            };
        }
        
        function autoOpenShopWithName() {
            const params = getUrlParams();
            const name = params.name;
            const shouldOpenShop = params.shop === 'true';
            const shareData = params.share;
            const giftId = params.gift;
            
            // å¤„ç†ç¤¼ç‰©é“¾æ¥
            if (giftId) {
                processGiftUrl(giftId);
                return;
            }
            
            // å¤„ç†åˆ†äº«é“¾æ¥
            if (shareData) {
                try {
                    const decodedData = decodeURIComponent(shareData);
                    const shareSettings = JSON.parse(decodedData);
                    processShareUrl(shareSettings);
                    return;
                } catch (e) {
                    console.log('åˆ†äº«æ•°æ®è§£æå¤±è´¥:', e);
                }
            }
            
            // æ­£å¸¸æ‰“å¼€è‡ªå·±çš„å°åº—
            if (name && shouldOpenShop) {
                const usernameInput = document.getElementById('username');
                const mainTitle = document.querySelector('#main-container h1');
                const store = document.getElementById('store');
                const startBtn = document.getElementById('start-btn');
                const countdown = document.getElementById('countdown');
                const shareBtn = document.getElementById('share-btn');
                const bunny = document.getElementById('bunny');
                
                if (usernameInput && mainTitle && store && startBtn && countdown && shareBtn && bunny) {
                    usernameInput.value = name;
                    
                    const now = getBeijingTime();
                    const isChristmas = checkIfChristmasDay();
                    
                    if (isChristmas || now >= targetTime) {
                        mainTitle.textContent = `ğŸ„ ${name}çš„åœ£è¯å°åº— ğŸ„`;
                        store.style.display = 'block';
                        startBtn.style.display = 'none';
                        usernameInput.style.display = 'none';
                        countdown.style.display = 'none';
                        shareBtn.style.display = 'inline-block';
                        bunny.src = 'assets/3.gif';
                        
                        document.getElementById('edit-shop-name').style.display = 'inline-block';
                        
                        initGiftEvents();
                        initBackpack();
                        
                        console.log(`ğŸ„ è‡ªåŠ¨å¼€å¯ ${name} çš„åœ£è¯å°åº—`);
                    } else {
                        usernameInput.value = name;
                        bunny.src = 'assets/1.gif';
                    }
                }
            }
        }
        
        // =================== å…¶ä»–åŠŸèƒ½ ===================
        
        // è·å–ç‰©å“å›¾æ ‡
        function getItemIcon(itemName) {
            if (itemName.includes('ç¤¼ç›’')) return 'ğŸ';
            if (itemName.includes('è¢œ')) return 'ğŸ§¦';
            if (itemName.includes('å¸½')) return 'ğŸ…';
            if (itemName.includes('æ ‘')) return 'ğŸ„';
            if (itemName.includes('ç³–æœ')) return 'ğŸ¬';
            if (itemName.includes('é“ƒé“›')) return 'ğŸ””';
            if (itemName.includes('è´ºå¡')) return 'ğŸ“';
            if (itemName === 'è°¢è°¢æƒ é¡¾') return 'ğŸ™';
            return 'ğŸ';
        }
        
        // =================== æ—¶é—´ç³»ç»Ÿ ===================
        let targetTime = getTargetTime();
        
        function getBeijingTime() {
            const now = new Date();
            const utc = now.getTime() + now.getTimezoneOffset() * 60000;
            return new Date(utc + 8 * 3600000);
        }
        
        function getTargetTime() {
            const now = getBeijingTime();
            const currentYear = now.getFullYear();
            return new Date(currentYear, 11, 25, 0, 0, 0, 0);
        }
        
        function checkIfChristmasDay() {
            const now = getBeijingTime();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            return month === 12 && date === 25;
        }
        
        // =================== åˆå§‹åŒ– ===================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
            initializeUserSystem();
            
            // åˆå§‹åŒ–VIPçŠ¶æ€
            initializeVIPStatus();
            
            // åˆå§‹åŒ–é»˜è®¤ç›²ç›’è®¾ç½®
            initializeDefaultBlindBoxItems();
            
            // åˆå§‹åŒ–èƒŒåŒ…
            initBackpack();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è‡ªåŠ¨æ‰“å¼€å•†åº—
            setTimeout(autoOpenShopWithName, 100);
            
            // æ£€æŸ¥å¹¶æ’­æ”¾åœ£è¯éŸ³ä¹
            if (checkIfChristmasDay()) {
                setTimeout(() => {
                    // éŸ³ä¹æ’­æ”¾ä»£ç ï¼ˆåŸä»£ç ï¼‰
                }, 1000);
            }
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç¤¼ç‰©äº¤æ¢æŒ‰é’®
            document.getElementById('exchange-btn').addEventListener('click', showGiftExchangeModal);
            
            // ç›²ç›’æŒ‰é’®
            document.getElementById('share-btn').addEventListener('click', function() {
                if (isVisitingOtherShop && visitedShopOwnerId) {
                    // è®¿é—®åˆ«äººçš„å°åº—ï¼ŒæŠ½å–ä»–ä»¬çš„ç›²ç›’
                    showBlindBoxPage(visitedShopOwnerId);
                } else {
                    // è‡ªå·±çš„å°åº—ï¼ŒæŠ½å–è‡ªå·±çš„ç›²ç›’
                    showBlindBoxPage(currentUserId);
                }
            });
            
            // è¿”å›å°åº—æŒ‰é’®
            document.getElementById('back-to-store').addEventListener('click', function() {
                document.getElementById('blind-box-container').style.display = 'none';
                document.getElementById('store').style.display = 'block';
                document.getElementById('share-btn').style.display = 'inline-block';
            });
            
            // å¼€å¯åœ£è¯æŒ‰é’®
            document.getElementById('start-btn').addEventListener('click', handleStartShop);
        }
        
        // å¤„ç†å¼€å¯å•†åº—
        function handleStartShop() {
            const now = getBeijingTime();
            const isChristmas = checkIfChristmasDay();
            
            if (now < targetTime && !isChristmas) {
                showBunnyModal('å•†åº—è¿˜æ²¡å¼€é—¨', 'åœ£è¯è€çˆ·çˆ·è¿˜åœ¨å‡†å¤‡ä¸­ï½<br>è¯·ç­‰å¾…å€’è®¡æ—¶ç»“æŸå“¦ï¼â°');
                return;
            }
            
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) {
                showBunnyModal('è¯·è¾“å…¥åå­—', 'å°å…”å­æƒ³çŸ¥é“ä½ çš„åå­—ï½<br>è¿™æ ·æ‰å¥½ä¸ºä½ å‡†å¤‡ç¤¼ç‰©å‘€ï¼ğŸ');
                return;
            }
            
            document.querySelector('#main-container h1').textContent = `ğŸ„ ${nameInput}çš„åœ£è¯å°åº— ğŸ„`;
            const store = document.getElementById('store');
            store.style.display = 'block';
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('username').style.display = 'none';
            document.getElementById('countdown').style.display = 'none';
            document.getElementById('share-btn').style.display = 'inline-block';
            
            document.getElementById('edit-shop-name').style.display = 'inline-block';
            document.getElementById('bunny').src = 'assets/3.gif';
            
            initGiftEvents();
            
            if (checkIfChristmasDay()) {
                setTimeout(() => {
                    // éŸ³ä¹æ’­æ”¾ä»£ç 
                }, 1000);
            }
        }
        
        // åˆå§‹åŒ–ç¤¼ç›’äº‹ä»¶ï¼ˆè®¿å®¢æ¨¡å¼ï¼‰
        function initGiftEventsForVisitor() {
            const gifts = document.querySelectorAll('.gift-item');
            gifts.forEach((gift, index) => {
                gift.removeEventListener('click', handleGiftClick);
                gift.addEventListener('click', function() {
                    showBunnyModal('æ— æ³•å¼€å¯', 'è¿™æ˜¯åº—ä¸»ä¸“å±çš„ç¤¼ç›’ï¼Œæ— æ³•å¼€å¯å“¦ï¼<br>ä½ å¯ä»¥æŠ½å–ç›²ç›’è·å¾—ç¤¼ç‰©ã€‚', false);
                });
            });
        }
        
        // åŸæ¥çš„ç¤¼ç›’äº‹ä»¶åˆå§‹åŒ–
        function initGiftEvents() {
            const gifts = document.querySelectorAll('.gift-item');
            gifts.forEach((gift, index) => {
                gift.removeEventListener('click', handleGiftClick);
                gift.addEventListener('click', function() {
                    handleGiftClick.call(this, index);
                });
            });
            
            updateGiftDisplay();
        }
        
        function handleGiftClick(index) {
            const openedGifts = getOpenedGifts();
            
            if (isVIP) {
                playGiftVideo(index);
                return;
            }
            
            if (openedGifts.length > 0 && !openedGifts.includes(index)) {
                showDogModal('åªèƒ½å¼€å¯ä¸€ä¸ªç¤¼ç›’', 'æ¯ä¸ªç”¨æˆ·åªèƒ½å¼€å¯ä¸€ä¸ªåœ£è¯å°åº—ç¤¼ç›’å“¦ï¼<br>å…¶ä»–ç¤¼ç›’å¯ä»¥åœ¨ç›²ç›’ä¸­æŠ½å–ã€‚<br>æˆä¸ºVIPå¯ä»¥è§£é”æ‰€æœ‰ç¤¼ç›’ï¼', false);
                return;
            }
            
            if (openedGifts.includes(index)) {
                playGiftVideo(index);
                return;
            }
            
            saveOpenedGift(index);
            playGiftVideo(index);
            updateGiftDisplay();
            
            setTimeout(() => {
                showDogModal('æ­å–œï¼', 'ä½ å·²æˆåŠŸå¼€å¯ä¸€ä¸ªåœ£è¯ç¤¼ç›’ï¼<br>ç°åœ¨å¯ä»¥å»æŠ½å–ç›²ç›’äº†ï¼', false);
                document.getElementById('share-btn').textContent = 'ğŸ æŠ½å–ç›²ç›’';
            }, 3000);
        }
        
        // =================== ä»¥ä¸‹ä¸ºåŸæœ‰ä»£ç çš„ä¿ç•™éƒ¨åˆ† ===================
        // æ³¨ï¼šè¿™é‡Œä¿ç•™äº†åŸæœ‰çš„ç¤¼ç›’å¼€å¯é€»è¾‘ã€éŸ³ä¹ç³»ç»Ÿã€æ—¶é—´ç³»ç»Ÿç­‰
        // ç”±äºä»£ç é•¿åº¦é™åˆ¶ï¼Œè¿™é‡Œåªä¿ç•™äº†å…³é”®éƒ¨åˆ†
        
        // åŸæœ‰çš„ç¤¼ç›’ç›¸å…³å‡½æ•°
        function getOpenedGifts() {
            const openedGifts = localStorage.getItem(`opened_gifts_${currentUserId}`);
            return openedGifts ? JSON.parse(openedGifts) : [];
        }
        
        function saveOpenedGift(giftIndex) {
            const openedGifts = getOpenedGifts();
            if (!openedGifts.includes(giftIndex)) {
                openedGifts.push(giftIndex);
                localStorage.setItem(`opened_gifts_${currentUserId}`, JSON.stringify(openedGifts));
            }
        }
        
        function updateGiftDisplay() {
            const openedGifts = getOpenedGifts();
            const gifts = document.querySelectorAll('.gift-item');
            
            gifts.forEach((gift, index) => {
                if (openedGifts.includes(index)) {
                    gift.classList.remove('disabled');
                } else if (openedGifts.length > 0 && !isVIP) {
                    gift.classList.add('disabled');
                } else {
                    gift.classList.remove('disabled');
                }
            });
        }
        
        // æ’­æ”¾ç¤¼ç›’è§†é¢‘
        function playGiftVideo(giftIndex, fromStore = true) {
            const gift = document.querySelectorAll('.gift-item')[giftIndex];
            const videoSrc = gift.dataset.video;
            const giftTitle = gift.querySelector('.gift-title').textContent;
            
            if (fromStore) {
                addItemToBackpack(giftTitle);
            }
            
            const name = document.querySelector('#main-container h1').textContent.replace('ğŸ„', '').replace('çš„åœ£è¯å°åº—', '').replace('ğŸ„', '').trim();
            
            const wrapper = document.createElement('div');
            wrapper.className = 'video-wrapper';
            
            const video = document.createElement('video');
            video.src = videoSrc;
            video.autoplay = true;
            video.controls = false;
            video.loop = false;
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.playsInline = true;
            video.webkitPlaysInline = true;
            
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            overlay.innerHTML = `<div class="name">${name}</div><div class="merry">Merry Christmas!</div>`;
            
            wrapper.appendChild(video);
            wrapper.appendChild(overlay);
            document.body.appendChild(wrapper);
            
            // è§†é¢‘ç»“æŸå¤„ç†
            video.addEventListener('ended', () => {
                wrapper.remove();
            });
            
            wrapper.addEventListener('click', (e) => {
                if (e.target === wrapper || e.target === video) {
                    wrapper.remove();
                }
            });
        }
        
        // å¼¹çª—ç³»ç»Ÿ
        function showBunnyModal(title, message, showInput = false, modalType = 'normal') {
            // åŸæœ‰çš„å¼¹çª—ä»£ç 
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'bunny-modal';
            modal.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                ${showInput ? '<input type="text" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " maxlength="4">' : ''}
                <button id="modal-btn">${showInput ? 'ç¡®å®š' : 'å¥½çš„'}</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // äº‹ä»¶å¤„ç†
            const modalBtn = document.getElementById('modal-btn');
            modalBtn.addEventListener('click', () => {
                if (showInput && modalType === 'vip') {
                    const passwordInput = document.getElementById('password-input');
                    if (passwordInput.value === '2303') {
                        document.body.removeChild(overlay);
                        document.body.removeChild(modal);
                        activateVIP();
                    } else {
                        document.body.removeChild(overlay);
                        document.body.removeChild(modal);
                        setTimeout(() => {
                            showBunnyModal('å¯†ç é”™è¯¯', 'VIPå¯†ç ä¸å¯¹å“¦ï½å†æƒ³æƒ³å§ï¼', true, 'vip');
                        }, 300);
                    }
                } else {
                    document.body.removeChild(overlay);
                    document.body.removeChild(modal);
                }
            });
        }
        
        function activateVIP() {
            setVIPStatus(true);
            document.getElementById('vip-btn').textContent = 'VIPå·²æ¿€æ´»';
            document.getElementById('vip-btn').style.background = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
            updateGiftDisplay();
            showBunnyModal('VIPæ¿€æ´»æˆåŠŸ', 'æ­å–œæ‚¨æˆä¸ºVIPç”¨æˆ·ï¼<br>ç°åœ¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åœ£è¯æƒŠå–œç¤¼ç›’äº†ï¼', false);
        }
        
        // å€’è®¡æ—¶ç³»ç»Ÿ
        const timeEl = document.getElementById('time');
        function updateCountdown() {
            const now = getBeijingTime();
            let diff = targetTime - now;
            const isChristmas = checkIfChristmasDay();
            
            if (diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                timeEl.textContent = `${days}å¤© ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('start-btn').classList.remove('active');
            } else if (isChristmas) {
                timeEl.textContent = '0å¤© 00:00:00';
                document.getElementById('start-btn').classList.add('active');
            } else if (diff <= 0 && !isChristmas) {
                timeEl.textContent = 'åœ£è¯èŠ‚å·²è¿‡';
                document.getElementById('start-btn').classList.remove('active');
            }
        }
        
        setInterval(updateCountdown, 1000);
        updateCountdown();
        
        // =================== æ§åˆ¶å°æµ‹è¯•å‘½ä»¤ ===================
        console.log(`
ğŸ„ åœ£è¯æµ‹è¯•å‘½ä»¤ï¼š
1. æµ‹è¯•èƒŒåŒ…ç³»ç»Ÿ: testBackpack()
2. æµ‹è¯•äº¤æ¢ç³»ç»Ÿ: testExchange()
3. æµ‹è¯•ç›²ç›’ç³»ç»Ÿ: testBlindBox()
4. ç”Ÿæˆæµ‹è¯•ç¤¼ç‰©: createTestGift()
5. æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯: showUserInfo()
        `);
        
        window.testBackpack = function() {
            console.log('=== èƒŒåŒ…æµ‹è¯• ===');
            console.log('èƒŒåŒ…ç‰©å“:', backpackItems);
            console.log('ç”¨æˆ·ID:', currentUserId);
            
            // æ·»åŠ æµ‹è¯•ç‰©å“
            addItemToBackpack('åœ£è¯æƒŠå–œç¤¼ç›’1');
            addItemToBackpack('åœ£è¯æƒŠå–œç¤¼ç›’2');
            addItemToBackpack('åœ£è¯æƒŠå–œç¤¼ç›’1'); // é‡å¤æ·»åŠ 
            
            console.log('æ·»åŠ åèƒŒåŒ…:', backpackItems);
            showBackpack();
        };
        
        window.testExchange = function() {
            console.log('=== äº¤æ¢ç³»ç»Ÿæµ‹è¯• ===');
            showGiftExchangeModal();
        };
        
        window.testBlindBox = function() {
            console.log('=== ç›²ç›’ç³»ç»Ÿæµ‹è¯• ===');
            initializeDefaultBlindBoxItems();
            generateBlindBoxPrizes();
            console.log('ç›²ç›’ç‰©å“:', blindBoxItems);
            console.log('ç”Ÿæˆçš„å¥–å“:', blindBoxPrizes);
            showBlindBoxPage(currentUserId);
        };
        
        window.createTestGift = function() {
            const giftId = `TEST_GIFT_${Date.now()}`;
            const giftData = {
                id: giftId,
                itemName: 'åœ£è¯æƒŠå–œç¤¼ç›’1',
                actionType: 'gift',
                fromUserId: 'TEST_USER',
                fromUserName: 'æµ‹è¯•ç”¨æˆ·',
                createdAt: Date.now(),
                expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000)
            };
            
            localStorage.setItem(`gift_${giftId}`, JSON.stringify(giftData));
            
            const baseUrl = window.location.origin + window.location.pathname;
            const giftUrl = `${baseUrl}?gift=${giftId}`;
            
            console.log('æµ‹è¯•ç¤¼ç‰©é“¾æ¥:', giftUrl);
            showBunnyModal('æµ‹è¯•ç¤¼ç‰©', `æµ‹è¯•ç¤¼ç‰©é“¾æ¥å·²ç”Ÿæˆï¼š<br><small>${giftUrl}</small>`, false);
        };
        
        window.showUserInfo = function() {
            console.log('=== ç”¨æˆ·ä¿¡æ¯ ===');
            console.log('ç”¨æˆ·ID:', currentUserId);
            console.log('ç”¨æˆ·ä¿¡æ¯:', currentUserInfo);
            console.log('èƒŒåŒ…ç‰©å“:', backpackItems);
            console.log('ç›²ç›’è®¾ç½®:', blindBoxItems);
        };
    </script>
</body>
</html>
